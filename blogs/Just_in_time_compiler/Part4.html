<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Just In Time Compiler - Part 4. BF optimization - 讓我們進入加速的世界吧 | Coding Hub</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/coding-hub/code.ico">
    <link rel="manifest" href="/coding-hub/manifest.json">
    <link rel="apple-touch-icon" href="/coding-hub/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/coding-hub/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <meta name="description" content="直譯器最佳化 + Just In Time Compiler 實作">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/app_icons/192.png">
    <meta name="msapplication-TileColor" content="#FFFFFF">
    
    <link rel="preload" href="/coding-hub/assets/css/0.styles.2277b98e.css" as="style"><link rel="preload" href="/coding-hub/assets/js/app.df64d80b.js" as="script"><link rel="preload" href="/coding-hub/assets/js/6.5a677154.js" as="script"><link rel="preload" href="/coding-hub/assets/js/1.0bfbaed9.js" as="script"><link rel="preload" href="/coding-hub/assets/js/26.5f1157e4.js" as="script"><link rel="preload" href="/coding-hub/assets/js/11.c55c4bcd.js" as="script"><link rel="prefetch" href="/coding-hub/assets/js/10.153f0244.js"><link rel="prefetch" href="/coding-hub/assets/js/12.5069d591.js"><link rel="prefetch" href="/coding-hub/assets/js/13.288e3bf1.js"><link rel="prefetch" href="/coding-hub/assets/js/14.98923b0d.js"><link rel="prefetch" href="/coding-hub/assets/js/15.12c58ad1.js"><link rel="prefetch" href="/coding-hub/assets/js/16.0b588d4f.js"><link rel="prefetch" href="/coding-hub/assets/js/17.f13925a9.js"><link rel="prefetch" href="/coding-hub/assets/js/18.47e56f78.js"><link rel="prefetch" href="/coding-hub/assets/js/19.bf916fa9.js"><link rel="prefetch" href="/coding-hub/assets/js/20.a4e1868f.js"><link rel="prefetch" href="/coding-hub/assets/js/21.0e84c3fb.js"><link rel="prefetch" href="/coding-hub/assets/js/22.c39fdcb6.js"><link rel="prefetch" href="/coding-hub/assets/js/23.0e9db64a.js"><link rel="prefetch" href="/coding-hub/assets/js/24.1b64b869.js"><link rel="prefetch" href="/coding-hub/assets/js/25.bee36556.js"><link rel="prefetch" href="/coding-hub/assets/js/27.fa8870a1.js"><link rel="prefetch" href="/coding-hub/assets/js/28.80c49a2c.js"><link rel="prefetch" href="/coding-hub/assets/js/29.b0305a5d.js"><link rel="prefetch" href="/coding-hub/assets/js/30.ee376dfa.js"><link rel="prefetch" href="/coding-hub/assets/js/31.2d302251.js"><link rel="prefetch" href="/coding-hub/assets/js/32.1e1bc032.js"><link rel="prefetch" href="/coding-hub/assets/js/33.72890909.js"><link rel="prefetch" href="/coding-hub/assets/js/34.fa67bc52.js"><link rel="prefetch" href="/coding-hub/assets/js/35.f74092dd.js"><link rel="prefetch" href="/coding-hub/assets/js/36.a847b223.js"><link rel="prefetch" href="/coding-hub/assets/js/37.1b012f6e.js"><link rel="prefetch" href="/coding-hub/assets/js/38.7628525e.js"><link rel="prefetch" href="/coding-hub/assets/js/39.f8aff88f.js"><link rel="prefetch" href="/coding-hub/assets/js/40.91e31a7c.js"><link rel="prefetch" href="/coding-hub/assets/js/41.d151ce20.js"><link rel="prefetch" href="/coding-hub/assets/js/42.824efee6.js"><link rel="prefetch" href="/coding-hub/assets/js/43.103899ed.js"><link rel="prefetch" href="/coding-hub/assets/js/44.4998e954.js"><link rel="prefetch" href="/coding-hub/assets/js/7.ff64a05d.js"><link rel="prefetch" href="/coding-hub/assets/js/8.9c5e7b1f.js"><link rel="prefetch" href="/coding-hub/assets/js/9.df73a708.js"><link rel="prefetch" href="/coding-hub/assets/js/vendors~flowchart.15880f81.js"><link rel="prefetch" href="/coding-hub/assets/js/vendors~mermaid.db8915cf.js"><link rel="prefetch" href="/coding-hub/assets/js/vendors~reveal.2eb356a7.js">
    <link rel="stylesheet" href="/coding-hub/assets/css/0.styles.2277b98e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>Coding Hub</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc>Less is more.</p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>Lawrence</span>
            
          <span data-v-4e82dffc>2021 - </span>
          2023
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/coding-hub/" class="home-link router-link-active"><img src="/coding-hub/coding.png" alt="Coding Hub" class="logo"> <span class="site-name">Coding Hub</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/coding-hub/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/coding-hub/categories/ELF/" class="nav-link"><i class="undefined"></i>
  ELF
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/JIT compiler/" class="nav-link"><i class="undefined"></i>
  JIT compiler
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/IEEE 754/" class="nav-link"><i class="undefined"></i>
  IEEE 754
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/AI Compiler/" class="nav-link"><i class="undefined"></i>
  AI Compiler
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/Pypy and Rpython/" class="nav-link"><i class="undefined"></i>
  Pypy and Rpython
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/LLVM/" class="nav-link"><i class="undefined"></i>
  LLVM
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/Python Internal/" class="nav-link"><i class="undefined"></i>
  Python Internal
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/Virtual Machine/" class="nav-link"><i class="undefined"></i>
  Virtual Machine
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/MLIR/" class="nav-link"><i class="undefined"></i>
  MLIR
</a></li></ul></div></div><div class="nav-item"><a href="/coding-hub/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/coding-hub/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="/coding-hub/blogs/aboutme/aboutme.html" class="nav-link"><i class="iconfont reco-account"></i>
  About me
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/lovelessless99" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.linkedin.com/in/chih-yu-hsu-06a0091b8/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-linkedin"></i>
  Linkedin
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="mailto:lovelessless99@gmail.com" class="nav-link external"><i class="iconfont reco-mail"></i>
  Gmail
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><img src="/coding-hub/head.gif" alt="author-avatar" class="personal-img" data-v-828910c6> <h3 class="name" data-v-828910c6>
    Lawrence
  </h3> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>22</h3> <h6 data-v-828910c6>Articles</h6></div> <div data-v-828910c6><h3 data-v-828910c6>16</h3> <h6 data-v-828910c6>Tags</h6></div></div> <ul class="social-links" data-v-828910c6></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/coding-hub/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/coding-hub/categories/ELF/" class="nav-link"><i class="undefined"></i>
  ELF
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/JIT compiler/" class="nav-link"><i class="undefined"></i>
  JIT compiler
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/IEEE 754/" class="nav-link"><i class="undefined"></i>
  IEEE 754
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/AI Compiler/" class="nav-link"><i class="undefined"></i>
  AI Compiler
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/Pypy and Rpython/" class="nav-link"><i class="undefined"></i>
  Pypy and Rpython
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/LLVM/" class="nav-link"><i class="undefined"></i>
  LLVM
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/Python Internal/" class="nav-link"><i class="undefined"></i>
  Python Internal
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/Virtual Machine/" class="nav-link"><i class="undefined"></i>
  Virtual Machine
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/MLIR/" class="nav-link"><i class="undefined"></i>
  MLIR
</a></li></ul></div></div><div class="nav-item"><a href="/coding-hub/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/coding-hub/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="/coding-hub/blogs/aboutme/aboutme.html" class="nav-link"><i class="iconfont reco-account"></i>
  About me
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/lovelessless99" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.linkedin.com/in/chih-yu-hsu-06a0091b8/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-linkedin"></i>
  Linkedin
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="mailto:lovelessless99@gmail.com" class="nav-link external"><i class="iconfont reco-mail"></i>
  Gmail
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Just In Time Compiler</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/coding-hub/blogs/Just_in_time_compiler/JIT.html" class="sidebar-link">Just In Time Compiler - Part 0. 專案說明與綜觀介紹</a></li><li><a href="/coding-hub/blogs/Just_in_time_compiler/Part1.html" class="sidebar-link">Just In Time Compiler - Part 1. 認識 JIT 及建立簡單的(?) JIT</a></li><li><a href="/coding-hub/blogs/Just_in_time_compiler/Part2.html" class="sidebar-link">Just In Time Compiler - Part 2. Brainfuck compiler and Interpreter</a></li><li><a href="/coding-hub/blogs/Just_in_time_compiler/Part3.html" class="sidebar-link">Just In Time Compiler - Part 3. Brainfuck compiler and interpreter 比較與探討</a></li><li><a href="/coding-hub/blogs/Just_in_time_compiler/Part4.html" aria-current="page" class="active sidebar-link">Just In Time Compiler - Part 4. BF optimization - 讓我們進入加速的世界吧</a></li><li><a href="/coding-hub/blogs/Just_in_time_compiler/Part5.html" class="sidebar-link">Just In Time Compiler - Part 5. Cross Comparison - 效能大亂鬥</a></li><li><a href="/coding-hub/blogs/Just_in_time_compiler/Part6.html" class="sidebar-link">Just In Time Compiler - Part 6. Threaded Code - 跳出迴圈的魔咒</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>Just In Time Compiler - Part 4. BF optimization - 讓我們進入加速的世界吧</h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>Lawrence</span>
            
          <span data-v-4e82dffc>2021 - </span>
          2023
        </a></span></div></div> <div data-v-1156296a><main class="page" style="padding-right:0;"><section><div class="page-title"><h1 class="title">Just In Time Compiler - Part 4. BF optimization - 讓我們進入加速的世界吧</h1> <div data-v-1ff7123e><i class="iconfont reco-account" data-v-1ff7123e><span data-v-1ff7123e>Lawrence</span></i> <i class="iconfont reco-date" data-v-1ff7123e><span data-v-1ff7123e>5/18/2021</span></i> <!----> <i class="tags iconfont reco-tag" data-v-1ff7123e><span class="tag-item" data-v-1ff7123e>JIT compiler</span><span class="tag-item" data-v-1ff7123e>Compiler</span></i></div></div> <div class="theme-reco-content content__default"><h1 id="part-4-bf-optimization"><a href="#part-4-bf-optimization" class="header-anchor">#</a> Part 4. BF optimization</h1> <p>我們在本 Part 要實作 just-in-time compiler，每個小結會附上參考連結，其實 JIT compiler ，及時(just in time)就是在執行期間產生機器碼去執行而已。所以我們需要懂得是</p> <ul><li>機器碼跟組合語言的對應</li> <li>組合語言的知識 (caller-saved, callee-saved register)</li></ul> <p>再將指令翻譯成機器碼就可以送到可至執行記憶體區段做執行，就是簡單的及時編譯器。因此，JIT 的步驟可以簡化為兩階段</p> <ol><li>產生機器碼，存到可執行記憶體區段</li> <li>在執行期間執行機器碼</li></ol> <p>這章的內容有點多，先給大家一個 big-picture</p> <div data-code="graph%20TD%0A%20%20%20%20naive(JIT%2C%20Interpreter)%20--%20%E5%8A%A0%E9%80%9F%E6%8B%AC%E8%99%9F%E5%8C%B9%E9%85%8D%20--%3E%20int_opt1(jumptable)%20--%E9%A0%90%E8%A8%88%E7%AE%97%E9%80%A3%E7%BA%8C%E7%AC%A6%E8%99%9F--%3E%20int_opt2(jumptable%20%2B%20count_continue)--%3Estatistic(%E7%B5%B1%E8%A8%88%E5%87%BA%E8%BF%B4%E5%9C%88%E7%89%B9%E5%BE%B5%E7%9A%84%E9%A0%BB%E7%8E%87%2F%E7%86%B1%E5%BA%A6)%0A%0A%20%20%20%20statistic%20--%3E%20loop1(clear%20loop)%0A%20%20%20%20statistic%20--%3E%20loop2(move%20ptr%20loop)%0A%20%20%20%20statistic%20--%3E%20loop3(move%20data%20loop)%0A%20%20%20%20statistic%20--%3E%20loop4(multiple%20loop)%0A%20%20%20%20%0A%0A%20%20%20%20int_opt3(jumptable%20%2B%20count_continue%20%2B%20%E5%8B%95%E6%85%8B%E8%A6%8F%E5%8A%83%E5%8A%A0%E9%80%9F%E7%89%B9%E5%AE%9A%20loop%20%E7%89%B9%E5%BE%B5)%0A%20%20%20%20loop1%20--%3E%20int_opt3%0A%20%20%20%20loop2%20--%3E%20int_opt3%0A%20%20%20%20loop3%20--%3E%20int_opt3%0A%20%20%20%20loop4%20--%3E%20int_opt3%0A" class="md-mermaid-loading"><svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" style="background:0 0;display:block;shape-rendering:auto;"><circle cx="50" cy="50" r="0" fill="none" stroke="currentColor" stroke-width="2"><animate attributeName="r" repeatCount="indefinite" dur="1s" values="0;40" keyTimes="0;1" keySplines="0 0.2 0.8 1" calcMode="spline" begin="0s"></animate> <animate attributeName="opacity" repeatCount="indefinite" dur="1s" values="1;0" keyTimes="0;1" keySplines="0.2 0 0.8 1" calcMode="spline" begin="0s"></animate></circle> <circle cx="50" cy="50" r="0" fill="none" stroke="currentColor" stroke-width="2"><animate attributeName="r" repeatCount="indefinite" dur="1s" values="0;40" keyTimes="0;1" keySplines="0 0.2 0.8 1" calcMode="spline" begin="-0.3333333333333333s"></animate> <animate attributeName="opacity" repeatCount="indefinite" dur="1s" values="1;0" keyTimes="0;1" keySplines="0.2 0 0.8 1" calcMode="spline" begin="-0.3333333333333333s"></animate></circle> <circle cx="50" cy="50" r="0" fill="none" stroke="currentColor" stroke-width="2"><animate attributeName="r" repeatCount="indefinite" dur="1s" values="0;40" keyTimes="0;1" keySplines="0 0.2 0.8 1" calcMode="spline" begin="-0.6666666666666666s"></animate> <animate attributeName="opacity" repeatCount="indefinite" dur="1s" values="1;0" keyTimes="0;1" keySplines="0.2 0 0.8 1" calcMode="spline" begin="-0.6666666666666666s"></animate></circle></svg></div><h2 id="_4-1-interpreter-optimization"><a href="#_4-1-interpreter-optimization" class="header-anchor">#</a> 4.1 Interpreter optimization</h2> <p>有鑑於直譯器的速度實在是太慢，因此在這裡介紹幾種方式進行加速，而之後不論是編譯器或是及時編譯器的加速方法也會結合直譯器的最佳化方式，加速加速再加速(摸斗摸斗嗨壓苦🤩)</p> <h3 id="_4-1-1-jumptable"><a href="#_4-1-1-jumptable" class="header-anchor">#</a> 4.1-1 Jumptable</h3> <p>其實這裡就有點像是之前 Part2 實作 compiler 和 JIT compiler 一樣的做法，就是不用來回 scan loops，在每一次的迴圈都要尋找括號配對， 可以把時間複雜度從 O(n) 降至 O(1)</p> <blockquote><p><a href="https://eli.thegreenplace.net/2017/adventures-in-jit-compilation-part-1-an-interpreter/" target="_blank" rel="noopener noreferrer">參考這個網站<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>節錄一段此文章話</p> <blockquote><p>Imagine a realistic program with a hot inner loop (by &quot;hot&quot; here I mean it runs many, many - possibly billions - of times throughtout the execution of the program). Is it really necessary to scan the source to find the matching bracket every single time? Of course not. We can just precompute these jump destinations ahead of time, since the BF program doesn't change throughout its execution.</p></blockquote> <p>其實就是說，如果今天的內迴圈很<code>hot</code>，可能有上百億次的執行，那每次的執行我們是否還需要找配對括號，抑或是可以先<code>預計算</code>解決小小的效能瓶頸 ?
因此我們可以製作一個跳表，當迴圈結束後直接跳到括號結尾的位置</p> <p>從原來需要來回檢查括號迴圈</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token keyword">case</span> <span class="token char">'['</span><span class="token operator">:</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// counter = 0, go to the end bracket</span>
          <span class="token punctuation">{</span>
                  <span class="token keyword">int</span> loop <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                  <span class="token keyword">while</span> <span class="token punctuation">(</span>loop <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> 
                  <span class="token punctuation">{</span>
                          current_char <span class="token operator">=</span> input<span class="token punctuation">[</span><span class="token operator">++</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                          <span class="token keyword">if</span> <span class="token punctuation">(</span>current_char <span class="token operator">==</span> <span class="token char">']'</span><span class="token punctuation">)</span> 
                          <span class="token punctuation">{</span> 
                                  <span class="token operator">--</span>loop<span class="token punctuation">;</span> 
                          <span class="token punctuation">}</span>
                                  
                          <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current_char <span class="token operator">==</span> <span class="token char">'['</span><span class="token punctuation">)</span>
                          <span class="token punctuation">{</span>
                                  <span class="token operator">++</span>loop<span class="token punctuation">;</span>
                          <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>

<span class="token keyword">case</span> <span class="token char">']'</span><span class="token operator">:</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>ptr<span class="token punctuation">)</span> 
          <span class="token punctuation">{</span>
                  <span class="token keyword">int</span> loop <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                  <span class="token keyword">while</span> <span class="token punctuation">(</span>loop <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// back to start bracket</span>
                  <span class="token punctuation">{</span>
                          current_char <span class="token operator">=</span> input<span class="token punctuation">[</span><span class="token operator">--</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                          <span class="token keyword">if</span> <span class="token punctuation">(</span>current_char <span class="token operator">==</span> <span class="token char">'['</span><span class="token punctuation">)</span>
                          <span class="token punctuation">{</span>
                                  <span class="token operator">--</span>loop<span class="token punctuation">;</span>
                          <span class="token punctuation">}</span>

                          <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current_char <span class="token operator">==</span> <span class="token char">']'</span><span class="token punctuation">)</span>
                          <span class="token punctuation">{</span>
                                  <span class="token operator">++</span>loop<span class="token punctuation">;</span>
                          <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>到直接查表直接跳到迴圈起始終止位置，和 Part 2 的 sed 利用對照表轉成的 C code 迴圈有異曲同工之妙，下列程式碼在
<code>Part4-BF_optimization/BF_interpreter_opt/BF_interpreter_opt1.c</code>找的到</p> <div class="language-C line-numbers-mode"><div class="highlight-lines"><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-c"><code><span class="token comment">// 製作跳表</span>
<span class="token keyword">int</span><span class="token operator">*</span> <span class="token function">compute_jumptable</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> input<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">size_t</span> pc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">size_t</span> program_size <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span><span class="token operator">*</span> jumptable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">calloc</span><span class="token punctuation">(</span>program_size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">while</span> <span class="token punctuation">(</span>pc <span class="token operator">&lt;</span> program_size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">char</span> instruction <span class="token operator">=</span> input<span class="token punctuation">[</span>pc<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>instruction <span class="token operator">==</span> <span class="token char">'['</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">int</span> bracket_nesting <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                        <span class="token class-name">size_t</span> seek <span class="token operator">=</span> pc<span class="token punctuation">;</span>

                        <span class="token keyword">while</span> <span class="token punctuation">(</span>bracket_nesting <span class="token operator">&amp;&amp;</span> <span class="token operator">++</span>seek <span class="token operator">&lt;</span> program_size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>input<span class="token punctuation">[</span>seek<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">']'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                        bracket_nesting<span class="token operator">--</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>input<span class="token punctuation">[</span>seek<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'['</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                        bracket_nesting<span class="token operator">++</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bracket_nesting<span class="token punctuation">)</span> 
                        <span class="token punctuation">{</span>
                                jumptable<span class="token punctuation">[</span>pc<span class="token punctuation">]</span> <span class="token operator">=</span> seek<span class="token punctuation">;</span>
                                jumptable<span class="token punctuation">[</span>seek<span class="token punctuation">]</span> <span class="token operator">=</span> pc<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">else</span> 
                        <span class="token punctuation">{</span>
                                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;unmatched '[' at pc= %lu\n&quot;</span><span class="token punctuation">,</span> pc<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                pc<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> jumptable<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// input is a const array to const char.</span>
<span class="token keyword">void</span> <span class="token function">interpreter</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> input<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token comment">// ASCII 8 bit.</span>
        <span class="token class-name">uint8_t</span> tape<span class="token punctuation">[</span><span class="token number">30000</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// set pointer to the left most cell of the tape.</span>
        <span class="token class-name">uint8_t</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> tape<span class="token punctuation">;</span>
        <span class="token keyword">char</span> current_char<span class="token punctuation">;</span>

        <span class="token keyword">int</span><span class="token operator">*</span> jumptable <span class="token operator">=</span> <span class="token function">compute_jumptable</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// printf(&quot;%s\n&quot;, input);</span>

        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> <span class="token punctuation">(</span>current_char <span class="token operator">=</span> input<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
                <span class="token keyword">switch</span><span class="token punctuation">(</span>current_char<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                        <span class="token keyword">case</span> <span class="token char">'&gt;'</span><span class="token operator">:</span> 
                                <span class="token operator">++</span>ptr<span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                        
                        <span class="token keyword">case</span> <span class="token char">'&lt;'</span><span class="token operator">:</span>
                                <span class="token operator">--</span>ptr<span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                        
                        <span class="token keyword">case</span> <span class="token char">'+'</span><span class="token operator">:</span>
                                <span class="token operator">++</span><span class="token punctuation">(</span><span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>

                        <span class="token keyword">case</span> <span class="token char">'-'</span><span class="token operator">:</span>
                                <span class="token operator">--</span><span class="token punctuation">(</span><span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>

                        <span class="token keyword">case</span> <span class="token char">'.'</span><span class="token operator">:</span>
                                <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>

                        <span class="token keyword">case</span> <span class="token char">','</span><span class="token operator">:</span>
                                <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>

                        <span class="token keyword">case</span> <span class="token char">'['</span><span class="token operator">:</span>

                        
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// counter = 0, go to the end bracket</span>
                                <span class="token punctuation">{</span>
                                        i  <span class="token operator">=</span> jumptable<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>

                        <span class="token keyword">case</span> <span class="token char">']'</span><span class="token operator">:</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>ptr<span class="token punctuation">)</span> 
                                <span class="token punctuation">{</span>
                                        i <span class="token operator">=</span> jumptable<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>

                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span>       
                <span class="token function">err</span><span class="token punctuation">(</span><span class="token string">&quot;Usage: interpreter &lt;inputfile&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>file_contents <span class="token operator">=</span> <span class="token function">read_file</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>file_contents <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
                <span class="token function">err</span><span class="token punctuation">(</span><span class="token string">&quot;Couldn't open file&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
	<span class="token function">interpreter</span><span class="token punctuation">(</span>file_contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>file_contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br></div></div><h3 id="_4-1-2-jumptable-contraction"><a href="#_4-1-2-jumptable-contraction" class="header-anchor">#</a> 4.1-2 Jumptable + Contraction</h3> <p>在利用 Jumptable 做加速後，我們再以此為基底，進行運算的壓縮。針對 <code>&gt;</code>, <code>&lt;</code>, <code>+</code>, <code>-</code>進行預計算。接下來就敘述一下思考流程。</p> <blockquote><ul><li><a href="http://accu.cc/content/jit_tour/brainfuck_interpreter/" target="_blank" rel="noopener noreferrer">參考網站1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://hackmd.io/@nKngvyhpQdGagg1V6GKLwA/HJjoxbvke?type=view#2016q3-Homework5---JIT-compiler" target="_blank" rel="noopener noreferrer">參考網站2<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></blockquote> <p>如同參考網站1所述，其實我們仔細看 brainfuck 的 hello world 的程式</p> <div class="language-bf line-numbers-mode"><pre class="language-text"><code>++++++++++[&gt;+++++++&gt;++++++++++&gt;+++&gt;+&lt;&lt;&lt;&lt;-]
&gt;++.&gt;+.+++++++..+++.&gt;++.&lt;&lt;+++++++++++++++.
&gt;.+++.------.--------.&gt;+.&gt;.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>把它轉成中間碼形式，以下是節錄至該網站</p> <blockquote><p>中間語言(英語: Intermediate Language, IR), 在計算機科學中, 是指一種應用於抽像機器(abstract machine)的編程語言, 它設計的目的, 是用來幫助我們分析計算機程序. 這個術語源自於編譯器, 在編譯器將源代碼編譯為目的碼的過程中, 會先將源代碼轉換為一個或多個的中間表述, 以方便編譯器進行最佳化, 並產生出目的機器的機器語言。</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>[
    ADD,     ADD,     ADD,     ADD,     ADD,     ADD,     ADD,     ADD,
    ADD,     ADD,     LB,      SHR,     ADD,     ADD,     ADD,     ADD,
    ADD,     ADD,     ADD,     SHR,     ADD,     ADD,     ADD,     ADD,
    ADD,     ADD,     ADD,     ADD,     ADD,     ADD,     SHR,     ADD,
    ADD,     ADD,     SHR,     ADD,     SHL,     SHL,     SHL,     SHL,
    SUB,     RB,      SHR,     ADD,     ADD,     PUTCHAR, SHR,     ADD,
    PUTCHAR, ADD,     ADD,     ADD,     ADD,     ADD,     ADD,     ADD,
    PUTCHAR, PUTCHAR, ADD,     ADD,     ADD,     PUTCHAR, SHR,     ADD,
    ADD,     PUTCHAR, SHL,     SHL,     ADD,     ADD,     ADD,     ADD,
    ADD,     ADD,     ADD,     ADD,     ADD,     ADD,     ADD,     ADD,
    ADD,     ADD,     ADD,     PUTCHAR, SHR,     PUTCHAR, ADD,     ADD,
    ADD,     PUTCHAR, SUB,     SUB,     SUB,     SUB,     SUB,     SUB,
    PUTCHAR, SUB,     SUB,     SUB,     SUB,     SUB,     SUB,     SUB,
    SUB,     PUTCHAR, SHR,     ADD,     PUTCHAR, SHR,     PUTCHAR,
]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>你會發現，<mark>其實蠻多冗餘</mark> 成分可以讓我們去最佳化，例如本小結的重點 contraction，就是壓縮指令。我們可以壓縮
連續的運算，例如連續 10 個 ADD，用中間碼表示就是 ADD(10)</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[
    ADD(10),  JIZ(12),  SHR(1),  ADD(7),  SHR(1),  ADD(10),  SHR(1),  ADD(3),
    SHR(1),   ADD(1),   SHL(4),  SUB(1),  JNZ(1),  SHR(1),   ADD(2),  PUTCHAR,
    SHR(1),   ADD(1),   PUTCHAR, ADD(7),  PUTCHAR, PUTCHAR,  ADD(3),  PUTCHAR,
    SHR(1),   ADD(2),   PUTCHAR, SHL(2),  ADD(15), PUTCHAR,  SHR(1),  PUTCHAR,
    ADD(3),   PUTCHAR,  SUB(6),  PUTCHAR, SUB(8),  PUTCHAR,  SHR(1),  ADD(1),
    PUTCHAR,  SHR(1),   PUTCHAR
]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>對相鄰的相同操作符進行折疊操作，你可以發現中間程式碼變得很短，其中迴圈的部分</p> <div class="language-bf line-numbers-mode"><pre class="language-text"><code>[&gt;+++++++&gt;++++++++++&gt;+++&gt;+&lt;&lt;&lt;&lt;-]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>由原本的</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>LB,      SHR,     ADD,     ADD,     ADD,     ADD,
ADD,     ADD,     ADD,     SHR,     ADD,     ADD,     ADD,     ADD,
ADD,     ADD,     ADD,     ADD,     ADD,     ADD,     SHR,     ADD,
ADD,     ADD,     SHR,     ADD,     SHL,     SHL,     SHL,     SHL,SUB,     RB
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>壓縮成</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>JIZ(12),  SHR(1),  ADD(7),  SHR(1),  ADD(10),  SHR(1),  ADD(3),
SHR(1),   ADD(1),   SHL(4),  SUB(1),  JNZ(1)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>JIZ(12) 表示往後跳 12 個指令</p></blockquote> <p>這是簡單的壓縮，當然你想的到的話也可以做更多其他的最佳化😀</p> <p>而在 <a href="https://hackmd.io/@nKngvyhpQdGagg1V6GKLwA/HJjoxbvke?type=view#2016q3-Homework5---JIT-compiler" target="_blank" rel="noopener noreferrer">jserv的homework<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，也有提到對於壓縮的最佳化，只是沒有轉成中間碼，而是使用自訂義函式去數連續的相同操作個數</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">continuous_count</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> p<span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>ptr <span class="token operator">==</span> <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        count<span class="token operator">++</span><span class="token punctuation">;</span>
        ptr<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>將此方法結合到我們的 jumptable 程式碼內，程式碼在 <code>BF_interpreter_opt/BF_interpreter_opt2.c</code></p> <div class="language-C line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">continuous_count</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> p<span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>ptr <span class="token operator">==</span> <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        count<span class="token operator">++</span><span class="token punctuation">;</span>
        ptr<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span><span class="token operator">*</span> <span class="token function">compute_jumptable</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> input<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">size_t</span> pc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token class-name">size_t</span> program_size <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span><span class="token operator">*</span> jumptable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">calloc</span><span class="token punctuation">(</span>program_size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  

  <span class="token keyword">while</span> <span class="token punctuation">(</span>pc <span class="token operator">&lt;</span> program_size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span> instruction <span class="token operator">=</span> input<span class="token punctuation">[</span>pc<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instruction <span class="token operator">==</span> <span class="token char">'['</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> bracket_nesting <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token class-name">size_t</span> seek <span class="token operator">=</span> pc<span class="token punctuation">;</span>

                <span class="token keyword">while</span> <span class="token punctuation">(</span>bracket_nesting <span class="token operator">&amp;&amp;</span> <span class="token operator">++</span>seek <span class="token operator">&lt;</span> program_size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>input<span class="token punctuation">[</span>seek<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">']'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                bracket_nesting<span class="token operator">--</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>input<span class="token punctuation">[</span>seek<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'['</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                bracket_nesting<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bracket_nesting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                jumptable<span class="token punctuation">[</span>pc<span class="token punctuation">]</span> <span class="token operator">=</span> seek<span class="token punctuation">;</span>
                jumptable<span class="token punctuation">[</span>seek<span class="token punctuation">]</span> <span class="token operator">=</span> pc<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;unmatched '[' at pc= %lu\n&quot;</span><span class="token punctuation">,</span> pc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        pc<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> jumptable<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// input is a const array to const char.</span>
<span class="token keyword">void</span> <span class="token function">interpreter</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> input<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token comment">// ASCII 8 bit.</span>
        <span class="token class-name">uint8_t</span> tape<span class="token punctuation">[</span><span class="token number">30000</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// set pointer to the left most cell of the tape.</span>
        <span class="token class-name">uint8_t</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> tape<span class="token punctuation">;</span>
        <span class="token keyword">char</span> current_char<span class="token punctuation">;</span>

        <span class="token keyword">int</span><span class="token operator">*</span> jumptable <span class="token operator">=</span> <span class="token function">compute_jumptable</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> count <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> <span class="token punctuation">(</span>current_char <span class="token operator">=</span> input<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
                <span class="token keyword">switch</span><span class="token punctuation">(</span>current_char<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                        <span class="token keyword">case</span> <span class="token char">'&gt;'</span><span class="token operator">:</span> 
                                count <span class="token operator">=</span> <span class="token function">continuous_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                i <span class="token operator">+=</span> count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                                ptr <span class="token operator">+=</span> count<span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                        
                        <span class="token keyword">case</span> <span class="token char">'&lt;'</span><span class="token operator">:</span>
                                count <span class="token operator">=</span> <span class="token function">continuous_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                i <span class="token operator">+=</span> count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                                ptr <span class="token operator">-=</span> count<span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                        
                        <span class="token keyword">case</span> <span class="token char">'+'</span><span class="token operator">:</span>
                                count <span class="token operator">=</span> <span class="token function">continuous_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                i <span class="token operator">+=</span> count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                                <span class="token operator">*</span>ptr <span class="token operator">+=</span> count<span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>

                        <span class="token keyword">case</span> <span class="token char">'-'</span><span class="token operator">:</span>
                                count <span class="token operator">=</span> <span class="token function">continuous_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                i <span class="token operator">+=</span> count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                                <span class="token operator">*</span>ptr <span class="token operator">-=</span> count<span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>

                        <span class="token keyword">case</span> <span class="token char">'.'</span><span class="token operator">:</span>
                                <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>

                        <span class="token keyword">case</span> <span class="token char">','</span><span class="token operator">:</span>
                                <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>

                        <span class="token keyword">case</span> <span class="token char">'['</span><span class="token operator">:</span>

                        
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// counter = 0, go to the end bracket</span>
                                <span class="token punctuation">{</span>
                                        i  <span class="token operator">=</span> jumptable<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>

                        <span class="token keyword">case</span> <span class="token char">']'</span><span class="token operator">:</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>ptr<span class="token punctuation">)</span> 
                                <span class="token punctuation">{</span>
                                        i <span class="token operator">=</span> jumptable<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>

                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br></div></div><h3 id="_4-1-3-統計迴圈的動作-loop-pattern-進行更深入的最佳化"><a href="#_4-1-3-統計迴圈的動作-loop-pattern-進行更深入的最佳化" class="header-anchor">#</a> 4.1-3 統計迴圈的動作(loop pattern)，進行更深入的最佳化</h3> <p>這裡有利用 C++ 的 <code>unorder_map</code> 容器進行統計所有的運算次數，以及迴圈(不計巢狀迴圈)的運算次數，程式碼在
<code>BF_interpreter_opt/BF_interpreter_statistic.cpp</code>，因為這是在 4.1-2 的程式碼內加入統計程式碼，因此
跑 <strong>碎形的brainfuck程式碼可能會比較慢一點</strong> ，輸出結果如下。</p> <p>首先是BF運算子在執行時的頻率</p> <table><thead><tr><th>BF運算子</th> <th>執行次數</th></tr></thead> <tbody><tr><td>.</td> <td>6240</td></tr> <tr><td>+</td> <td>173837849</td></tr> <tr><td>-</td> <td>177623020</td></tr> <tr><td>[</td> <td>422534152</td></tr> <tr><td>&lt;</td> <td>596892555</td></tr> <tr><td>&gt;</td> <td>811756172</td></tr> <tr><td>]</td> <td>835818921</td></tr></tbody></table> <p>另外是非巢狀迴圈的執行頻率</p> <table><thead><tr><th>迴圈特徵</th> <th>執行次數</th> <th>迴圈動作</th> <th>迴圈特徵命名</th></tr></thead> <tbody><tr><td>[-&gt;++&gt;&gt;&gt;+++++&gt;++&gt;+&lt;&lt;&lt;&lt;&lt;&lt;]</td> <td>12</td> <td></td> <td>Multiple Loop</td></tr> <tr><td>[-&gt;+&gt;&gt;&gt;-&lt;&lt;&lt;&lt;]</td> <td>51084</td> <td></td> <td>Multiple Loop</td></tr> <tr><td>[-&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;+&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;]</td> <td>306294</td> <td>LOOP_MOVE_DATA</td> <td>Copy Loop</td></tr> <tr><td>[&gt;+&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;]</td> <td>9217819</td> <td></td> <td>Multiple Loop</td></tr> <tr><td>[-]</td> <td>12038491</td> <td>LOOP_SET_TO_ZERO</td> <td>Clear Loop</td></tr> <tr><td>[&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;]</td> <td>191420093</td> <td>LOOP_MOVE_PTR</td> <td>Move Loop</td></tr> <tr><td>[&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;]</td> <td>272106406</td> <td>LOOP_MOVE_PTR</td> <td>Move Loop</td></tr></tbody></table> <p>看到這些使用頻率高的迴圈，我們是不是可以針對較好處理的特徵再處理一下，使他們跑的速度變得更快
例如 :</p> <ol><li><p><code>[-]</code> : 把當前元素設成 0 (LOOP_SET_TO_ZERO, Clear Loop)</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span> <span class="token operator">*</span>ptr <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>或是可以直接簡化為</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p><code>[-&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;+&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;]</code>: 移動資料，將當前資料移到 9 格後的位置值 (LOOP_MOVE_DATA, Copy Loop)，寫成 C 語言就是</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> target<span class="token operator">=</span><span class="token operator">*</span>ptr<span class="token punctuation">;</span> <span class="token operator">*</span><span class="token punctuation">(</span>ptr<span class="token operator">+</span><span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">!=</span> target<span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token operator">--</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>ptr<span class="token operator">+</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token operator">++</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>或是可以直接簡化為</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token operator">*</span><span class="token punctuation">(</span>ptr <span class="token operator">+</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span>ptr
<span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p><code>[-&gt;++&gt;&gt;&gt;+++++&gt;++&gt;+&lt;&lt;&lt;&lt;&lt;&lt;]</code>: 這種迴圈就是一般的迴圈(Multiple Loop)，我們可以利用
<strong>動態規劃</strong>的方法，紀錄位移量跟對應的增加量，以此迴圈為例，從<code>[-</code>後開始儲存<code>&gt;++&gt;&gt;&gt;+++++&gt;++&gt;+&lt;&lt;&lt;&lt;&lt;&lt;]</code></p> <table><thead><tr><th>陣列索引</th> <th>0</th> <th>1</th> <th>2</th> <th>3</th></tr></thead> <tbody><tr><td>位移量</td> <td>1</td> <td>4</td> <td>5</td> <td>6</td></tr> <tr><td>位移後該位置加上的值</td> <td>2</td> <td>5</td> <td>2</td> <td>1</td></tr></tbody></table> <p>之後，假設這個迴圈要跑 10 次，要把第二列全部乘上 10</p> <table><thead><tr><th>陣列索引</th> <th>0</th> <th>1</th> <th>2</th> <th>3</th></tr></thead> <tbody><tr><td>位移量</td> <td>1</td> <td>4</td> <td>5</td> <td>6</td></tr> <tr><td>位移後該位置加上的值</td> <td>20</td> <td>50</td> <td>20</td> <td>10</td></tr></tbody></table> <p>就可以由此表格快速計算好結果，節省很多計算時間</p></li> <li><p><code>[&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;]</code>: 向右移 9 倍格，直到遇到值非零的格子(LOOP_MOVE_PTR, Move Loop)，寫成 C 語言就是</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token punctuation">;</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span> ptr <span class="token operator">+=</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ol> <p>接下來，我們就針對這四種迴圈，進行最佳化吧，首先是針對 1, 2, 3 Case 的最佳化，Case 1, 2, 3 的 <strong>共同特徵是以[-為開頭</strong> ，這裡參考
<a href="https://hackmd.io/@sysprog/SkBsZoReb?type=view" target="_blank" rel="noopener noreferrer">jserv's note<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 提供的<code>check_loops</code>程式碼</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">check_loops</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>index<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>mult<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> res<span class="token punctuation">,</span>offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>_index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token char">'-'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 匹配 [- 開頭的</span>
    p <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 跳過 [-</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">!=</span> <span class="token char">']'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果是 [-] 直接跳出迴圈</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'['</span> <span class="token operator">||</span> <span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'-'</span> <span class="token operator">||</span>
            <span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'.'</span> <span class="token operator">||</span> <span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">','</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 不匹配巢狀迴圈或是非 [- 開頭的</span>
        
        <span class="token comment">// 動態規劃核心程式</span>
        res <span class="token operator">=</span> <span class="token function">continuous_count</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'&gt;'</span><span class="token punctuation">)</span> offset <span class="token operator">+=</span> res<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'&lt;'</span><span class="token punctuation">)</span> offset <span class="token operator">-=</span> res<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'+'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            index<span class="token punctuation">[</span>_index<span class="token punctuation">]</span> <span class="token operator">=</span> offset<span class="token punctuation">;</span>
            mult<span class="token punctuation">[</span>_index<span class="token punctuation">]</span> <span class="token operator">=</span> res<span class="token punctuation">;</span>
            _index<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        p <span class="token operator">+=</span> res<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> _index<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>再來是仿照上述例子寫的 case 4 move-loop 程式碼</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">check_move_loops</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>p<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
        <span class="token keyword">int</span> res<span class="token punctuation">,</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token char">'&lt;'</span> <span class="token operator">||</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token char">'&gt;'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        p <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">!=</span> <span class="token char">']'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'['</span> <span class="token operator">||</span> <span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'-'</span> <span class="token operator">||</span> <span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'.'</span> <span class="token operator">||</span> <span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">','</span> <span class="token operator">||</span> <span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'+'</span> <span class="token operator">||</span> <span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
                res <span class="token operator">=</span> <span class="token function">continuous_count</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'&gt;'</span><span class="token punctuation">)</span> offset <span class="token operator">+=</span> res<span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'&lt;'</span><span class="token punctuation">)</span> offset <span class="token operator">-=</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> offset<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>完整程式碼如下，也可以去 <code>BF_interpreter_opt/BF_interpreter_opt3.c</code> 看</p> <div class="language-C line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;util.h&quot;</span></span>

<span class="token keyword">int</span> <span class="token function">continuous_count</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> p<span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>ptr <span class="token operator">==</span> <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        count<span class="token operator">++</span><span class="token punctuation">;</span>
        ptr<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">check_move_loops</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>p<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
        <span class="token keyword">int</span> res<span class="token punctuation">,</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token char">'&lt;'</span> <span class="token operator">||</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token char">'&gt;'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        p <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">!=</span> <span class="token char">']'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'['</span> <span class="token operator">||</span> <span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'-'</span> <span class="token operator">||</span> <span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'.'</span> <span class="token operator">||</span> <span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">','</span> <span class="token operator">||</span> <span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'+'</span> <span class="token operator">||</span> <span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
                res <span class="token operator">=</span> <span class="token function">continuous_count</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'&gt;'</span><span class="token punctuation">)</span> offset <span class="token operator">+=</span> res<span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'&lt;'</span><span class="token punctuation">)</span> offset <span class="token operator">-=</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> offset<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">check_loops</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>p<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>index<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>mult<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> res<span class="token punctuation">,</span>offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>_index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token char">'-'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 匹配 [- 開頭的</span>
    p <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 跳過 [-</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">!=</span> <span class="token char">']'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果是 [-] 直接跳出迴圈</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'['</span> <span class="token operator">||</span> <span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'-'</span> <span class="token operator">||</span>
            <span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'.'</span> <span class="token operator">||</span> <span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">','</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 不匹配巢狀迴圈或是非 [- 開頭的</span>
        
        <span class="token comment">// 動態規劃核心程式</span>
        res <span class="token operator">=</span> <span class="token function">continuous_count</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'&gt;'</span><span class="token punctuation">)</span> offset <span class="token operator">+=</span> res<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'&lt;'</span><span class="token punctuation">)</span> offset <span class="token operator">-=</span> res<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'+'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            index<span class="token punctuation">[</span>_index<span class="token punctuation">]</span> <span class="token operator">=</span> offset<span class="token punctuation">;</span>
            mult<span class="token punctuation">[</span>_index<span class="token punctuation">]</span> <span class="token operator">=</span> res<span class="token punctuation">;</span>
            _index<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        p <span class="token operator">+=</span> res<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> _index<span class="token punctuation">;</span>
<span class="token punctuation">}</span>



<span class="token keyword">int</span><span class="token operator">*</span> <span class="token function">compute_jumptable</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> input<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">size_t</span> pc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token class-name">size_t</span> program_size <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span><span class="token operator">*</span> jumptable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">calloc</span><span class="token punctuation">(</span>program_size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  

  <span class="token keyword">while</span> <span class="token punctuation">(</span>pc <span class="token operator">&lt;</span> program_size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span> instruction <span class="token operator">=</span> input<span class="token punctuation">[</span>pc<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instruction <span class="token operator">==</span> <span class="token char">'['</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> bracket_nesting <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token class-name">size_t</span> seek <span class="token operator">=</span> pc<span class="token punctuation">;</span>

                <span class="token keyword">while</span> <span class="token punctuation">(</span>bracket_nesting <span class="token operator">&amp;&amp;</span> <span class="token operator">++</span>seek <span class="token operator">&lt;</span> program_size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>input<span class="token punctuation">[</span>seek<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">']'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                bracket_nesting<span class="token operator">--</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>input<span class="token punctuation">[</span>seek<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'['</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                bracket_nesting<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bracket_nesting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                jumptable<span class="token punctuation">[</span>pc<span class="token punctuation">]</span> <span class="token operator">=</span> seek<span class="token punctuation">;</span>
                jumptable<span class="token punctuation">[</span>seek<span class="token punctuation">]</span> <span class="token operator">=</span> pc<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;unmatched '[' at pc= %lu\n&quot;</span><span class="token punctuation">,</span> pc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        pc<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> jumptable<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// input is a const array to const char.</span>
<span class="token keyword">void</span> <span class="token function">interpreter</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> input<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token comment">// ASCII 8 bit.</span>
        <span class="token class-name">uint8_t</span> tape<span class="token punctuation">[</span><span class="token number">30000</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// set pointer to the left most cell of the tape.</span>
        <span class="token class-name">uint8_t</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> tape<span class="token punctuation">;</span>
        <span class="token keyword">char</span> current_char<span class="token punctuation">;</span>

        <span class="token keyword">int</span><span class="token operator">*</span> jumptable <span class="token operator">=</span> <span class="token function">compute_jumptable</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">int</span> index<span class="token punctuation">[</span><span class="token number">300</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> mult<span class="token punctuation">[</span><span class="token number">300</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>


        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> count <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> <span class="token punctuation">(</span>current_char <span class="token operator">=</span> input<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
                
                <span class="token keyword">switch</span><span class="token punctuation">(</span>current_char<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                        <span class="token keyword">case</span> <span class="token char">'&gt;'</span><span class="token operator">:</span> 
                                count <span class="token operator">=</span> <span class="token function">continuous_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                i <span class="token operator">+=</span> count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                                ptr <span class="token operator">+=</span> count<span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                        
                        <span class="token keyword">case</span> <span class="token char">'&lt;'</span><span class="token operator">:</span>
                                count <span class="token operator">=</span> <span class="token function">continuous_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                i <span class="token operator">+=</span> count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                                ptr <span class="token operator">-=</span> count<span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                        
                        <span class="token keyword">case</span> <span class="token char">'+'</span><span class="token operator">:</span>
                                count <span class="token operator">=</span> <span class="token function">continuous_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                i <span class="token operator">+=</span> count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                                <span class="token operator">*</span>ptr <span class="token operator">+=</span> count<span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>

                        <span class="token keyword">case</span> <span class="token char">'-'</span><span class="token operator">:</span>
                                count <span class="token operator">=</span> <span class="token function">continuous_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                i <span class="token operator">+=</span> count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                                <span class="token operator">*</span>ptr <span class="token operator">-=</span> count<span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>

                        <span class="token keyword">case</span> <span class="token char">'.'</span><span class="token operator">:</span>
                                <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>

                        <span class="token keyword">case</span> <span class="token char">','</span><span class="token operator">:</span>
                                <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>

                        <span class="token keyword">case</span> <span class="token char">'['</span><span class="token operator">:</span>

                                <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span>ptr <span class="token punctuation">)</span> <span class="token comment">// catch out loop pattern </span>
                                <span class="token punctuation">{</span>

                                        count <span class="token operator">=</span> <span class="token function">check_loops</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> index<span class="token punctuation">,</span> mult<span class="token punctuation">)</span><span class="token punctuation">;</span>

                                        <span class="token keyword">if</span><span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// clear loop [-]</span>
                                                <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
                                                i  <span class="token operator">=</span> jumptable<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                                        <span class="token punctuation">}</span> <span class="token comment">// clear loop</span>

                                        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// multiple loop</span>
                                        <span class="token punctuation">{</span>
                                                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> loop_times <span class="token operator">=</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span> k <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> mult<span class="token punctuation">[</span>k<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">*=</span> loop_times<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> k <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> <span class="token operator">*</span><span class="token punctuation">(</span>ptr<span class="token operator">+</span>index<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+=</span>  mult<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> k<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                                i  <span class="token operator">=</span> jumptable<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                                        <span class="token punctuation">}</span>
                                        <span class="token keyword">else</span> 
                                        <span class="token punctuation">{</span>
                                                <span class="token comment">// move loop [&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;]</span>
                                                <span class="token keyword">int</span> mv_count <span class="token operator">=</span> <span class="token function">check_move_loops</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                                <span class="token keyword">if</span><span class="token punctuation">(</span>mv_count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                                                <span class="token punctuation">{</span>
                                                        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token operator">*</span>ptr<span class="token punctuation">;</span>  ptr <span class="token operator">+=</span> mv_count <span class="token punctuation">)</span><span class="token punctuation">;</span>
                                                        i  <span class="token operator">=</span> jumptable<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                                                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                                                <span class="token punctuation">}</span> 
                                        <span class="token punctuation">}</span>
                                <span class="token punctuation">}</span>

                                <span class="token keyword">else</span>     <span class="token comment">// counter = 0, go to the end bracket</span>
                                <span class="token punctuation">{</span>
                                        i  <span class="token operator">=</span> jumptable<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>

                        <span class="token keyword">case</span> <span class="token char">']'</span><span class="token operator">:</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>ptr<span class="token punctuation">)</span> 
                                <span class="token punctuation">{</span>
                                        i <span class="token operator">=</span> jumptable<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>

                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span>       
                <span class="token function">err</span><span class="token punctuation">(</span><span class="token string">&quot;Usage: interpreter &lt;inputfile&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>file_contents <span class="token operator">=</span> <span class="token function">read_file</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>file_contents <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
                <span class="token function">err</span><span class="token punctuation">(</span><span class="token string">&quot;Couldn't open file&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
	<span class="token function">interpreter</span><span class="token punctuation">(</span>file_contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>file_contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br></div></div><h2 id="_4-2-brainfuck-jit-compiler-with-opcode"><a href="#_4-2-brainfuck-jit-compiler-with-opcode" class="header-anchor">#</a> 4.2 Brainfuck JIT compiler with opcode</h2> <blockquote><ul><li><a href="https://nickdesaulniers.github.io/blog/2015/05/25/interpreter-compiler-jit/" target="_blank" rel="noopener noreferrer">參考網站<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/nickdesaulniers/bf_interpreter_jit_compiler" target="_blank" rel="noopener noreferrer">參考網站的Github<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
其實這裡的實作方法，和 Part2 的 compiler 相同，主要差異是將原先<strong>印出組合語言直接變成機器碼，再直接執行</strong>，就是一種動態編譯技術</li></ul></blockquote> <p>例如:</p> <ol><li>直譯器</li></ol> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token keyword">case</span> <span class="token char">'&gt;'</span><span class="token operator">:</span> <span class="token operator">++</span>ptr<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="2"><li>編譯器</li></ol> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token keyword">case</span> <span class="token char">'&gt;'</span><span class="token operator">:</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;  inc %r12&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="3"><li>及時編譯器</li></ol> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token keyword">case</span> <span class="token char">'&gt;'</span><span class="token operator">:</span>
<span class="token punctuation">{</span>
        <span class="token keyword">char</span> opcodes <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token number">0x49</span><span class="token punctuation">,</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token number">0xC4</span> <span class="token comment">// inc %r12</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">vector_push</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>instruction_stream<span class="token punctuation">,</span> opcodes<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>opcodes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>在這裡及時編譯器的行為就跟我們實作的編譯器一樣，只是我們又跳過了組譯這部直接產生機器碼存在記憶體，我們就是 <mark>一邊編譯一邊執行</mark> ，所以及時編譯器缺點也很明顯</p> <ul><li>仍需要讀檔、重新轉(re-parse, rerun)</li> <li>要動態產生機器碼</li> <li>很佔記憶體空間</li> <li>可執行區段可能會成為漏洞 (所以 ios 系統不允許 JIT 的實作)</li></ul> <p>因此，我們在這裡只要把前面的 compiler 輸出組語的部分直接轉成 opcode 就好。如果不知道怎麼轉，請參考<strong>Part 1. 揉合 objdump</strong>那段。
然而，列出一些缺點，但是優點是可以變快許多，為什麼 ?
原因是因為直譯器針對每一個讀進來的指令，至少要經過兩個 branch 指令，一個是 for-loop，一個是 switch-case，對於一個加法而言，<mark>JIT 只需要 add 的指令 一行</mark> 即可，而 <mark>一般直譯器需要經過數行指令才可以真正執行加法</mark> ，在 BF 程式碼運算十分複雜的情況下，這兩者在效能上的差異會大幅拉開。</p> <p>這段程式碼在 <code>JIT_opcode/jit_opcode.c</code> 資料夾下</p> <h2 id="_4-3-brainfuck-jit-compiler-with-dynasm"><a href="#_4-3-brainfuck-jit-compiler-with-dynasm" class="header-anchor">#</a> 4.3. Brainfuck JIT compiler with dynasm</h2> <h3 id="_4-3-1-jit-compiler"><a href="#_4-3-1-jit-compiler" class="header-anchor">#</a> 4.3-1. JIT compiler</h3> <blockquote><ul><li><a href="https://blog.reverberate.org/2012/12/hello-jit-world-joy-of-simple-jits.html" target="_blank" rel="noopener noreferrer">參考網站<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/haberman/jitdemo/blob/master/jit3.dasc" target="_blank" rel="noopener noreferrer">參考網站 Github<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></blockquote> <p>如果你可能對組合語言有些熟悉的話，又覺得前面直接放入 opcode 到程式碼內可讀性很低，那可以用 dynasm code generator 幫助我們組語寫完轉化成 opcode，程式碼放進 <code>JIT_Dynasm/jit_dynasm.dasc</code> 檔案內，值得一提的是，在這邊的程式碼已經有實作類似 4.1-1 jumptable 的方法。</p> <blockquote><p>有另外一個工具叫做 asmjit，有興趣可以玩玩看 😁</p></blockquote> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token comment">// JIT for Brainf*ck.</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h&gt;</span></span>

<span class="token operator">|</span><span class="token punctuation">.</span>arch x64
<span class="token operator">|</span><span class="token punctuation">.</span>actionlist actions
<span class="token operator">|</span>
<span class="token operator">|</span><span class="token comment">// Use rbx as our cell pointer.</span>
<span class="token operator">|</span><span class="token comment">// Since rbx is a callee-save register, it will be preserved</span>
<span class="token operator">|</span><span class="token comment">// across our calls to getchar and putchar.</span>
<span class="token operator">|</span><span class="token punctuation">.</span>define PTR<span class="token punctuation">,</span> rbx
<span class="token operator">|</span>
<span class="token operator">|</span><span class="token comment">// Macro for calling a function.</span>
<span class="token operator">|</span><span class="token comment">// In cases where our target is &lt;=2**32 away we can use</span>
<span class="token operator">|</span><span class="token comment">//   | call &amp;addr</span>
<span class="token operator">|</span><span class="token comment">// But since we don't know if it will be, we use this safe</span>
<span class="token operator">|</span><span class="token comment">// sequence instead.</span>
<span class="token operator">|</span><span class="token punctuation">.</span>macro callp<span class="token punctuation">,</span> addr
<span class="token operator">|</span>  mov64  rax<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>addr
<span class="token operator">|</span>  call   rax
<span class="token operator">|</span><span class="token punctuation">.</span>endmacro

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Dst</span> <span class="token expression"><span class="token operator">&amp;</span>state</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_NESTING</span> <span class="token expression"><span class="token number">256</span></span></span>

<span class="token keyword">void</span> <span class="token function">err</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;%s\n&quot;</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token function">err</span><span class="token punctuation">(</span><span class="token string">&quot;Usage: jit3 &lt;bf program&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  dasm_State <span class="token operator">*</span>state<span class="token punctuation">;</span>
  <span class="token function">initjit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>state<span class="token punctuation">,</span> actions<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> maxpc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> pcstack<span class="token punctuation">[</span>MAX_NESTING<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> <span class="token operator">*</span>top <span class="token operator">=</span> pcstack<span class="token punctuation">,</span> <span class="token operator">*</span>limit <span class="token operator">=</span> pcstack <span class="token operator">+</span> MAX_NESTING<span class="token punctuation">;</span>

  <span class="token comment">// Function prologue.</span>
  <span class="token operator">|</span>  push PTR
  <span class="token operator">|</span>  mov  PTR<span class="token punctuation">,</span> rdi

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">*</span>p<span class="token punctuation">;</span> p<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token char">'&gt;'</span><span class="token operator">:</span>
        <span class="token operator">|</span>  inc  PTR
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token char">'&lt;'</span><span class="token operator">:</span>
        <span class="token operator">|</span>  dec  PTR
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token char">'+'</span><span class="token operator">:</span>
        <span class="token operator">|</span>  inc  byte <span class="token punctuation">[</span>PTR<span class="token punctuation">]</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token char">'-'</span><span class="token operator">:</span>
        <span class="token operator">|</span>  dec  byte <span class="token punctuation">[</span>PTR<span class="token punctuation">]</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token char">'.'</span><span class="token operator">:</span>
        <span class="token operator">|</span>  movzx edi<span class="token punctuation">,</span> byte <span class="token punctuation">[</span>PTR<span class="token punctuation">]</span>
        <span class="token operator">|</span>  callp putchar
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token char">','</span><span class="token operator">:</span>
        <span class="token operator">|</span>  callp getchar
        <span class="token operator">|</span>  mov   byte <span class="token punctuation">[</span>PTR<span class="token punctuation">]</span><span class="token punctuation">,</span> al
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token char">'['</span><span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>top <span class="token operator">==</span> limit<span class="token punctuation">)</span> <span class="token function">err</span><span class="token punctuation">(</span><span class="token string">&quot;Nesting too deep.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Each loop gets two pclabels: at the beginning and end.</span>
        <span class="token comment">// We store pclabel offsets in a stack to link the loop</span>
        <span class="token comment">// begin and end together.</span>
        maxpc <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>top<span class="token operator">++</span> <span class="token operator">=</span> maxpc<span class="token punctuation">;</span>
        <span class="token function">dasm_growpc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>state<span class="token punctuation">,</span> maxpc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">|</span>  cmp  byte <span class="token punctuation">[</span>PTR<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span>
        <span class="token operator">|</span>  je   <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>maxpc<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token operator">|=</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>maxpc<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token char">']'</span><span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>top <span class="token operator">==</span> pcstack<span class="token punctuation">)</span> <span class="token function">err</span><span class="token punctuation">(</span><span class="token string">&quot;Unmatched ']'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        top<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token operator">|</span>  cmp  byte <span class="token punctuation">[</span>PTR<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span>
        <span class="token operator">|</span>  jne  <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">*</span>top<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token operator">|=</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">*</span>top<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">:</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Function epilogue.</span>
  <span class="token operator">|</span>  pop  PTR
  <span class="token operator">|</span>  ret

  <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>fptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">jitcode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>mem <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">30000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fptr</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">free</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">free_jitcode</span><span class="token punctuation">(</span>fptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br></div></div><p>比方才的機器語言的程式碼稍微簡潔不複雜，可讀性也提高了(不過組語本來就是提高機器語言的可讀性建立出來的高階語言(跟機器語言比的話)🤣)，因此藉由 dynasm 加上一些組合語言的知識，可以幫我們快速建立一個 JIT compiler</p> <h3 id="_4-3-2-jumptable-contraction"><a href="#_4-3-2-jumptable-contraction" class="header-anchor">#</a> 4.3-2. Jumptable + Contraction</h3> <p>承接上一個步驟，我們要像 4.1-2 一樣加入運算壓縮的技術，其實改動的地方很簡單，最主要是 <code>&gt;</code>, <code>&lt;</code>, <code>+</code>, <code>-</code> 的地方，程式碼在 <code>JIT_Dynasm/jit_dynasm_opt1.dasc</code></p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">*</span>p<span class="token punctuation">;</span> p<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token char">'&gt;'</span><span class="token operator">:</span>
        <span class="token operator">|</span>  inc  PTR
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token char">'&lt;'</span><span class="token operator">:</span>
        <span class="token operator">|</span>  dec  PTR
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token char">'+'</span><span class="token operator">:</span>
        <span class="token operator">|</span>  inc  byte <span class="token punctuation">[</span>PTR<span class="token punctuation">]</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token char">'-'</span><span class="token operator">:</span>
        <span class="token operator">|</span>  dec  byte <span class="token punctuation">[</span>PTR<span class="token punctuation">]</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token char">'.'</span><span class="token operator">:</span>
        <span class="token operator">|</span>  movzx edi<span class="token punctuation">,</span> byte <span class="token punctuation">[</span>PTR<span class="token punctuation">]</span>
        <span class="token operator">|</span>  callp putchar
        <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>在<code>.dasm</code>加入這個函數後</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">continuous_count</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> p<span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>ptr <span class="token operator">==</span> <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        count<span class="token operator">++</span><span class="token punctuation">;</span>
        ptr<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>修改組合語言指令</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> file_contents<span class="token punctuation">;</span> <span class="token operator">*</span>p<span class="token punctuation">;</span> p<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token char">'&gt;'</span><span class="token operator">:</span>
        count <span class="token operator">=</span> <span class="token function">continuous_count</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        p <span class="token operator">+=</span> count <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token operator">|</span>  add  PTR<span class="token punctuation">,</span> count
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token char">'&lt;'</span><span class="token operator">:</span>
        count <span class="token operator">=</span> <span class="token function">continuous_count</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        p <span class="token operator">+=</span> count <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token operator">|</span>  sub  PTR<span class="token punctuation">,</span> count
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token char">'+'</span><span class="token operator">:</span>
        count <span class="token operator">=</span> <span class="token function">continuous_count</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        p <span class="token operator">+=</span> count <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token operator">|</span>  add  byte <span class="token punctuation">[</span>PTR<span class="token punctuation">]</span><span class="token punctuation">,</span> count 
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token char">'-'</span><span class="token operator">:</span>
        count <span class="token operator">=</span> <span class="token function">continuous_count</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        p <span class="token operator">+=</span> count <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token operator">|</span>  sub  byte <span class="token punctuation">[</span>PTR<span class="token punctuation">]</span><span class="token punctuation">,</span> count
        <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>如此一來，可以先利用 <code>continuous_count</code> 先計算未來的連續符號個數，例如未來有五個 +，就可以把五個加法指令合併成一個加法指令<code>add PTR, 5</code>，如此一來，可以再加速上一個 jit 的實作</p> <h3 id="_4-3-3-clear-loop-multiple-loop-copy-loop"><a href="#_4-3-3-clear-loop-multiple-loop-copy-loop" class="header-anchor">#</a> 4.3-3. Clear Loop &amp; Multiple Loop &amp; Copy Loop</h3> <p>這裡如同 <code>4.1-3 統計迴圈的動作(loop pattern)，進行更深入的最佳化</code>，我們承接該小節直譯器的函數，來針對特定迴圈字串進行
最佳化，還記得嗎，先前經由分析，我們得到某些迴圈的頻率</p> <table><thead><tr><th>迴圈特徵</th> <th>執行次數</th> <th>迴圈動作</th> <th>迴圈特徵命名</th></tr></thead> <tbody><tr><td>[-&gt;++&gt;&gt;&gt;+++++&gt;++&gt;+&lt;&lt;&lt;&lt;&lt;&lt;]</td> <td>12</td> <td></td> <td>Multiple Loop</td></tr> <tr><td>[-&gt;+&gt;&gt;&gt;-&lt;&lt;&lt;&lt;]</td> <td>51084</td> <td></td> <td>Multiple Loop</td></tr> <tr><td>[-&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;+&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;]</td> <td>306294</td> <td>LOOP_MOVE_DATA</td> <td>Copy Loop</td></tr> <tr><td>[&gt;+&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;]</td> <td>9217819</td> <td></td> <td>Multiple Loop</td></tr> <tr><td>[-]</td> <td>12038491</td> <td>LOOP_SET_TO_ZERO</td> <td>Clear Loop</td></tr> <tr><td>[&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;]</td> <td>191420093</td> <td>LOOP_MOVE_PTR</td> <td>Move Loop</td></tr> <tr><td>[&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;]</td> <td>272106406</td> <td>LOOP_MOVE_PTR</td> <td>Move Loop</td></tr></tbody></table> <p>因此，我們針對這些很<strong>熱</strong>的特別迴圈，進行更深入的最佳化，這裡引用 global_count 來當作 jumptable 的功用，執行完 checkloop 之後的動作後，直接跳到指定位置，不重新執行。程式碼在<code>JIT_Dynasm/jit_dynasm_opt2.dasc</code></p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> global_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">check_loops</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>index<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>mult<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> res<span class="token punctuation">,</span>offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>_index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    global_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token char">'-'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    p <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    global_count <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">!=</span> <span class="token char">']'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'['</span> <span class="token operator">||</span> <span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'-'</span> <span class="token operator">||</span>
            <span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'.'</span> <span class="token operator">||</span> <span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">','</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        res <span class="token operator">=</span> <span class="token function">continuous_count</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'&gt;'</span><span class="token punctuation">)</span> offset <span class="token operator">+=</span> res<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'&lt;'</span><span class="token punctuation">)</span> offset <span class="token operator">-=</span> res<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'+'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            index<span class="token punctuation">[</span>_index<span class="token punctuation">]</span> <span class="token operator">=</span> offset<span class="token punctuation">;</span>
            mult<span class="token punctuation">[</span>_index<span class="token punctuation">]</span> <span class="token operator">=</span> res<span class="token punctuation">;</span>
            _index<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        global_count <span class="token operator">+=</span> res<span class="token punctuation">;</span>
        p <span class="token operator">+=</span> res<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> _index<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>原本的程式碼</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token keyword">case</span> <span class="token char">'['</span><span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>top <span class="token operator">==</span> limit<span class="token punctuation">)</span> <span class="token function">err</span><span class="token punctuation">(</span><span class="token string">&quot;Nesting too deep.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Each loop gets two pclabels: at the beginning and end.</span>
        <span class="token comment">// We store pclabel offsets in a stack to link the loop</span>
        <span class="token comment">// begin and end together.</span>
        maxpc <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>top<span class="token operator">++</span> <span class="token operator">=</span> maxpc<span class="token punctuation">;</span>
        <span class="token function">dasm_growpc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>state<span class="token punctuation">,</span> maxpc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">|</span>  cmp  byte <span class="token punctuation">[</span>PTR<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span>
        <span class="token operator">|</span>  je   <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>maxpc<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token operator">|=</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>maxpc<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>改成下列程式碼</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token keyword">case</span> <span class="token char">'['</span><span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>top <span class="token operator">==</span> limit<span class="token punctuation">)</span> <span class="token function">err</span><span class="token punctuation">(</span><span class="token string">&quot;Nesting too deep.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        count <span class="token operator">=</span> <span class="token function">check_loops</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> index<span class="token punctuation">,</span> mult<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span><span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// clear loop</span>
          p <span class="token operator">+=</span> global_count<span class="token punctuation">;</span>
          <span class="token operator">|</span>  mov  byte <span class="token punctuation">[</span>PTR<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// DP solve multiple loop</span>
          <span class="token operator">|</span>  mov  cx<span class="token punctuation">,</span> word <span class="token punctuation">[</span>PTR<span class="token punctuation">]</span>
          <span class="token operator">|</span>  mov  r11<span class="token punctuation">,</span> PTR
          <span class="token operator">|</span>  add  PTR<span class="token punctuation">,</span> index<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
          <span class="token operator">|</span>  mov  ax<span class="token punctuation">,</span> word mult<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
          <span class="token operator">|</span>  imul  ax<span class="token punctuation">,</span> cx
          <span class="token operator">|</span>  add  byte <span class="token punctuation">[</span>PTR<span class="token punctuation">]</span><span class="token punctuation">,</span> al

          <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
              <span class="token operator">|</span>  mov  r9<span class="token punctuation">,</span> index<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
              <span class="token operator">|</span>  sub  r9<span class="token punctuation">,</span> index<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
              <span class="token operator">|</span>  add  PTR<span class="token punctuation">,</span> r9
              <span class="token operator">|</span>  mov  ax<span class="token punctuation">,</span> mult<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
              <span class="token operator">|</span>  imul  ax<span class="token punctuation">,</span> cx
              <span class="token operator">|</span>  add  byte <span class="token punctuation">[</span>PTR<span class="token punctuation">]</span><span class="token punctuation">,</span> al
          <span class="token punctuation">}</span>

          <span class="token operator">|</span>  mov  PTR<span class="token punctuation">,</span> r11
          <span class="token operator">|</span>  mov  byte <span class="token punctuation">[</span>PTR<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span>
        
          p <span class="token operator">+=</span> global_count<span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
          maxpc <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>
          <span class="token operator">*</span>top<span class="token operator">++</span> <span class="token operator">=</span> maxpc<span class="token punctuation">;</span>
          <span class="token function">dasm_growpc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>state<span class="token punctuation">,</span> maxpc<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token operator">|</span>  cmp  byte <span class="token punctuation">[</span>PTR<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span>
          <span class="token operator">|</span>  je   <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>maxpc<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>
          <span class="token operator">|=</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>maxpc<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h2 id="_4-4-最佳化總結"><a href="#_4-4-最佳化總結" class="header-anchor">#</a> 4.4 最佳化總結</h2> <p>在本章，我們先從直譯器的最佳化，實作三種最佳化方法</p> <ul><li>jumptable</li> <li>jumptable + contraction</li> <li>jumptable + contraction + loop-pattern</li></ul> <p>接下來我們又實作了 JIT compiler</p> <ul><li>jit in opcode( jumptable )</li> <li>Jit with dynasm
<ul><li>naive ( jumptable )</li> <li>naive ( jumptable ) + contraction</li> <li>naive ( jumptable ) + contraction + loop-pattern</li></ul></li></ul> <p>我們其實還有以下目標未完成，還有很多可以玩的😁</p> <ol><li>opcode ( jumptable ) + contraction</li> <li>opcode ( jumptable ) + contraction + loop-pattern</li> <li>compiler with  contraction + loop-pattern</li> <li>asmjit, llvm</li></ol> <p>那在下一章節 Part 5，我們會開始進行全方位的比較，終於迎來了大亂鬥的時刻。</p> <h2 id="專案執行方式"><a href="#專案執行方式" class="header-anchor">#</a> 專案執行方式</h2> <p>只要進到 <code>Part4-BF_optimization</code> 資料夾，下指令</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">make</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>就會自動編譯以上的程式碼，之後進到對應的資料夾即可執行程式</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>./<span class="token operator">&lt;</span>executable<span class="token operator">&gt;</span> mandelbrot.bf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">Tue Jul 06 2021 19:28:11 GMT+0800</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/coding-hub/blogs/Just_in_time_compiler/Part3.html" class="prev">
            Just In Time Compiler - Part 3. Brainfuck compiler and interpreter 比較與探討
          </a></span> <span class="next"><a href="/coding-hub/blogs/Just_in_time_compiler/Part5.html">
            Just In Time Compiler - Part 5. Cross Comparison - 效能大亂鬥
          </a></span></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:0;" data-v-70334359></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><!----><!----><div class="vuepress-canvas-nest-element"></div><canvas id="vuepress-canvas-cursor"></canvas></div></div>
    <script src="/coding-hub/assets/js/app.df64d80b.js" defer></script><script src="/coding-hub/assets/js/6.5a677154.js" defer></script><script src="/coding-hub/assets/js/1.0bfbaed9.js" defer></script><script src="/coding-hub/assets/js/26.5f1157e4.js" defer></script><script src="/coding-hub/assets/js/11.c55c4bcd.js" defer></script>
  </body>
</html>
