<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Just In Time Compiler - Part 1. 認識 JIT 及建立簡單的(?) JIT | Coding Hub</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/coding-hub/code.ico">
    <link rel="manifest" href="/coding-hub/manifest.json">
    <link rel="apple-touch-icon" href="/coding-hub/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/coding-hub/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <meta name="description" content="Just In Time Compiler, 認識 JIT">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/app_icons/192.png">
    <meta name="msapplication-TileColor" content="#FFFFFF">
    
    <link rel="preload" href="/coding-hub/assets/css/0.styles.2277b98e.css" as="style"><link rel="preload" href="/coding-hub/assets/js/app.df64d80b.js" as="script"><link rel="preload" href="/coding-hub/assets/js/6.5a677154.js" as="script"><link rel="preload" href="/coding-hub/assets/js/1.0bfbaed9.js" as="script"><link rel="preload" href="/coding-hub/assets/js/23.0e9db64a.js" as="script"><link rel="preload" href="/coding-hub/assets/js/11.c55c4bcd.js" as="script"><link rel="prefetch" href="/coding-hub/assets/js/10.153f0244.js"><link rel="prefetch" href="/coding-hub/assets/js/12.5069d591.js"><link rel="prefetch" href="/coding-hub/assets/js/13.288e3bf1.js"><link rel="prefetch" href="/coding-hub/assets/js/14.98923b0d.js"><link rel="prefetch" href="/coding-hub/assets/js/15.12c58ad1.js"><link rel="prefetch" href="/coding-hub/assets/js/16.0b588d4f.js"><link rel="prefetch" href="/coding-hub/assets/js/17.f13925a9.js"><link rel="prefetch" href="/coding-hub/assets/js/18.47e56f78.js"><link rel="prefetch" href="/coding-hub/assets/js/19.bf916fa9.js"><link rel="prefetch" href="/coding-hub/assets/js/20.a4e1868f.js"><link rel="prefetch" href="/coding-hub/assets/js/21.0e84c3fb.js"><link rel="prefetch" href="/coding-hub/assets/js/22.c39fdcb6.js"><link rel="prefetch" href="/coding-hub/assets/js/24.1b64b869.js"><link rel="prefetch" href="/coding-hub/assets/js/25.bee36556.js"><link rel="prefetch" href="/coding-hub/assets/js/26.5f1157e4.js"><link rel="prefetch" href="/coding-hub/assets/js/27.fa8870a1.js"><link rel="prefetch" href="/coding-hub/assets/js/28.80c49a2c.js"><link rel="prefetch" href="/coding-hub/assets/js/29.b0305a5d.js"><link rel="prefetch" href="/coding-hub/assets/js/30.ee376dfa.js"><link rel="prefetch" href="/coding-hub/assets/js/31.2d302251.js"><link rel="prefetch" href="/coding-hub/assets/js/32.1e1bc032.js"><link rel="prefetch" href="/coding-hub/assets/js/33.72890909.js"><link rel="prefetch" href="/coding-hub/assets/js/34.fa67bc52.js"><link rel="prefetch" href="/coding-hub/assets/js/35.f74092dd.js"><link rel="prefetch" href="/coding-hub/assets/js/36.a847b223.js"><link rel="prefetch" href="/coding-hub/assets/js/37.1b012f6e.js"><link rel="prefetch" href="/coding-hub/assets/js/38.7628525e.js"><link rel="prefetch" href="/coding-hub/assets/js/39.f8aff88f.js"><link rel="prefetch" href="/coding-hub/assets/js/40.91e31a7c.js"><link rel="prefetch" href="/coding-hub/assets/js/41.d151ce20.js"><link rel="prefetch" href="/coding-hub/assets/js/42.824efee6.js"><link rel="prefetch" href="/coding-hub/assets/js/43.103899ed.js"><link rel="prefetch" href="/coding-hub/assets/js/44.4998e954.js"><link rel="prefetch" href="/coding-hub/assets/js/7.ff64a05d.js"><link rel="prefetch" href="/coding-hub/assets/js/8.9c5e7b1f.js"><link rel="prefetch" href="/coding-hub/assets/js/9.df73a708.js"><link rel="prefetch" href="/coding-hub/assets/js/vendors~flowchart.15880f81.js"><link rel="prefetch" href="/coding-hub/assets/js/vendors~mermaid.db8915cf.js"><link rel="prefetch" href="/coding-hub/assets/js/vendors~reveal.2eb356a7.js">
    <link rel="stylesheet" href="/coding-hub/assets/css/0.styles.2277b98e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>Coding Hub</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc>Less is more.</p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>Lawrence</span>
            
          <span data-v-4e82dffc>2021 - </span>
          2023
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/coding-hub/" class="home-link router-link-active"><img src="/coding-hub/coding.png" alt="Coding Hub" class="logo"> <span class="site-name">Coding Hub</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/coding-hub/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/coding-hub/categories/ELF/" class="nav-link"><i class="undefined"></i>
  ELF
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/JIT compiler/" class="nav-link"><i class="undefined"></i>
  JIT compiler
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/IEEE 754/" class="nav-link"><i class="undefined"></i>
  IEEE 754
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/AI Compiler/" class="nav-link"><i class="undefined"></i>
  AI Compiler
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/Pypy and Rpython/" class="nav-link"><i class="undefined"></i>
  Pypy and Rpython
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/LLVM/" class="nav-link"><i class="undefined"></i>
  LLVM
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/Python Internal/" class="nav-link"><i class="undefined"></i>
  Python Internal
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/Virtual Machine/" class="nav-link"><i class="undefined"></i>
  Virtual Machine
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/MLIR/" class="nav-link"><i class="undefined"></i>
  MLIR
</a></li></ul></div></div><div class="nav-item"><a href="/coding-hub/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/coding-hub/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="/coding-hub/blogs/aboutme/aboutme.html" class="nav-link"><i class="iconfont reco-account"></i>
  About me
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/lovelessless99" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.linkedin.com/in/chih-yu-hsu-06a0091b8/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-linkedin"></i>
  Linkedin
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="mailto:lovelessless99@gmail.com" class="nav-link external"><i class="iconfont reco-mail"></i>
  Gmail
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><img src="/coding-hub/head.gif" alt="author-avatar" class="personal-img" data-v-828910c6> <h3 class="name" data-v-828910c6>
    Lawrence
  </h3> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>22</h3> <h6 data-v-828910c6>Articles</h6></div> <div data-v-828910c6><h3 data-v-828910c6>16</h3> <h6 data-v-828910c6>Tags</h6></div></div> <ul class="social-links" data-v-828910c6></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/coding-hub/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/coding-hub/categories/ELF/" class="nav-link"><i class="undefined"></i>
  ELF
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/JIT compiler/" class="nav-link"><i class="undefined"></i>
  JIT compiler
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/IEEE 754/" class="nav-link"><i class="undefined"></i>
  IEEE 754
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/AI Compiler/" class="nav-link"><i class="undefined"></i>
  AI Compiler
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/Pypy and Rpython/" class="nav-link"><i class="undefined"></i>
  Pypy and Rpython
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/LLVM/" class="nav-link"><i class="undefined"></i>
  LLVM
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/Python Internal/" class="nav-link"><i class="undefined"></i>
  Python Internal
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/Virtual Machine/" class="nav-link"><i class="undefined"></i>
  Virtual Machine
</a></li><li class="dropdown-item"><!----> <a href="/coding-hub/categories/MLIR/" class="nav-link"><i class="undefined"></i>
  MLIR
</a></li></ul></div></div><div class="nav-item"><a href="/coding-hub/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/coding-hub/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="/coding-hub/blogs/aboutme/aboutme.html" class="nav-link"><i class="iconfont reco-account"></i>
  About me
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/lovelessless99" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.linkedin.com/in/chih-yu-hsu-06a0091b8/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-linkedin"></i>
  Linkedin
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="mailto:lovelessless99@gmail.com" class="nav-link external"><i class="iconfont reco-mail"></i>
  Gmail
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Just In Time Compiler</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/coding-hub/blogs/Just_in_time_compiler/JIT.html" class="sidebar-link">Just In Time Compiler - Part 0. 專案說明與綜觀介紹</a></li><li><a href="/coding-hub/blogs/Just_in_time_compiler/Part1.html" aria-current="page" class="active sidebar-link">Just In Time Compiler - Part 1. 認識 JIT 及建立簡單的(?) JIT</a></li><li><a href="/coding-hub/blogs/Just_in_time_compiler/Part2.html" class="sidebar-link">Just In Time Compiler - Part 2. Brainfuck compiler and Interpreter</a></li><li><a href="/coding-hub/blogs/Just_in_time_compiler/Part3.html" class="sidebar-link">Just In Time Compiler - Part 3. Brainfuck compiler and interpreter 比較與探討</a></li><li><a href="/coding-hub/blogs/Just_in_time_compiler/Part4.html" class="sidebar-link">Just In Time Compiler - Part 4. BF optimization - 讓我們進入加速的世界吧</a></li><li><a href="/coding-hub/blogs/Just_in_time_compiler/Part5.html" class="sidebar-link">Just In Time Compiler - Part 5. Cross Comparison - 效能大亂鬥</a></li><li><a href="/coding-hub/blogs/Just_in_time_compiler/Part6.html" class="sidebar-link">Just In Time Compiler - Part 6. Threaded Code - 跳出迴圈的魔咒</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>Just In Time Compiler - Part 1. 認識 JIT 及建立簡單的(?) JIT</h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>Lawrence</span>
            
          <span data-v-4e82dffc>2021 - </span>
          2023
        </a></span></div></div> <div data-v-1156296a><main class="page" style="padding-right:0;"><section><div class="page-title"><h1 class="title">Just In Time Compiler - Part 1. 認識 JIT 及建立簡單的(?) JIT</h1> <div data-v-1ff7123e><i class="iconfont reco-account" data-v-1ff7123e><span data-v-1ff7123e>Lawrence</span></i> <i class="iconfont reco-date" data-v-1ff7123e><span data-v-1ff7123e>5/8/2021</span></i> <!----> <i class="tags iconfont reco-tag" data-v-1ff7123e><span class="tag-item" data-v-1ff7123e>JIT compiler</span><span class="tag-item" data-v-1ff7123e>Compiler</span></i></div></div> <div class="theme-reco-content content__default"><h1 id="part-1-認識-jit-及建立簡單的-jit"><a href="#part-1-認識-jit-及建立簡單的-jit" class="header-anchor">#</a> Part 1. 認識 JIT 及建立簡單的(?) JIT</h1> <h2 id="一、just-in-time-的概念"><a href="#一、just-in-time-的概念" class="header-anchor">#</a> 一、Just-in-time 的概念</h2> <ul><li><p>使用到的大專案 : Google V8, Java Virtual Machine, C# Framework, RubyJIT, pypy, numba, DolphinDB 等</p></li> <li><p>動態編譯技術 (混合型編譯-結合 compiler and interpreter)</p></li> <li><p>Interpretor 執行的時候，會監看哪段程式碼是熱點(hot)程式碼，例如迴圈。發現後馬上送到 JIT 編譯成機器碼放在記憶體，下次執行時不用重新翻譯，類似快取的概念</p></li> <li><p>優點是，可以得到靜態編譯所沒有的訊息，知道哪些函數是不是被大量使用的，或是那些函數的參數一直都沒有變等等。一旦得到這些訊息，可以編譯出比靜態編譯器更好的機器碼。一般程式也是 90-10 原則。執行時 90% 的計算時間是跑 10% 的程式碼，只要找到這些熱點(hot-spot) 程式碼，就能進行更深度的優化</p></li> <li><p>缺點是</p> <ul><li>監看會耗費CPU資源</li> <li>儲存程式碼會耗費記憶體空間</li> <li>在 runtime 產生 code，每次重新啟動時又要重新監控(profiling)一次，沒有留紀錄，AOT (ahead-of-time) 改善此缺點</li></ul></li></ul> <h2 id="二、-hello-jit-world-the-joy-of-simple-jits"><a href="#二、-hello-jit-world-the-joy-of-simple-jits" class="header-anchor">#</a> 二、 Hello, JIT World: The Joy of Simple JITs</h2> <p>這是最簡單的 jit 範例，下面用 mmap 建立一塊可寫可執行的區域，但是一般最好不要用可執行的flag，因為可能會有安全上的問題。這也是為什麼不用 malloc 去宣告一塊記憶體，因為heap, stack 都是不可執行的記憶體區塊。</p> <p><a href="https://blog.reverberate.org/2012/12/hello-jit-world-joy-of-simple-jits.html" target="_blank" rel="noopener noreferrer">這個網站<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 也提到</p> <blockquote><p>You might wonder why you can’t call a function that just changes the permissions of the memory you get from malloc(). Having to allocate executable memory in a totally different way sounds like a drag. In fact there is a function that can change permissions on memory you already have; it’s called mprotect(). But these permissions can only be set on page boundaries; malloc() will give you some memory from the middle of a page, a page that you do not own in its entirety. If you start changing permissions on that page you’ll affect any other code that might be using memory in that page.</p></blockquote> <p>意思就是說，可以用 mprotect 改變 malloc 的權限，但是是以<code>頁</code> 為單位設權限，而不是只針對 malloc 分配出來的記憶體區塊。因此，如果只針對 malloc 進行 mprotect，可能會改變到其他使用到這個 page 的指令或是 code</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* jit_toy.c */</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token comment">// Machine code for:</span>
        <span class="token comment">//   mov eax, 0</span>
        <span class="token comment">//   ret</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">char</span> code<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0xb8</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xc3</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;Usage: jit1 &lt;integer&gt;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Overwrite immediate value &quot;0&quot; in the instruction</span>
        <span class="token comment">// with the user's value.  This will make our code:</span>
        <span class="token comment">//   mov eax, &lt;user's value&gt;</span>
        <span class="token comment">//   ret</span>
        <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>code<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>num<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Allocate writable/executable memory.</span>
        <span class="token comment">// Note: real programs should not map memory both writable</span>
        <span class="token comment">// and executable because it is a security risk.</span>
        <span class="token keyword">void</span> <span class="token operator">*</span>mem <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">,</span> PROT_WRITE <span class="token operator">|</span> PROT_EXEC<span class="token punctuation">,</span>
                        MAP_ANON <span class="token operator">|</span> MAP_PRIVATE<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> code<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// The function will return the user's value.</span>
        <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> mem<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">make</span> <span class="token punctuation">;</span> ./jit_toy <span class="token number">55</span><span class="token punctuation">;</span> <span class="token builtin class-name">echo</span> <span class="token variable">$?</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="二、hello-dynasm-world"><a href="#二、hello-dynasm-world" class="header-anchor">#</a> 二、Hello, DynASM World!</h2> <p><a href="https://luajit.org/dynasm.html" target="_blank" rel="noopener noreferrer">DynASM 官方網頁<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，特色如下</p> <ol><li><p>DynASM 是一個程式碼生成的動態組譯器(code generator)</p></li> <li><p>為 <code>LuaJIT</code> 開發主要工具</p></li> <li><p>DynASM 適用以下情境</p> <ul><li>撰寫一個 JIT compiler &lt;------ 我們要的 ^__^</li> <li>快速生成程式碼 (高效能的計算)</li></ul></li> <li><p>DynASM 把混合 C/Assembler code 轉成 C code.</p></li> <li><p>支援 x86, x64, ARM, ARM64, PowerPC and MIPS 指令集架構</p></li> <li><p><a href="https://luajit.org/dynasm_features.html" target="_blank" rel="noopener noreferrer">其他特色<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ol> <p>對 dynasm 有些初步的認識後，那為什麼要使用 dynasm 呢 ?
節錄至<a href="https://blog.reverberate.org/2012/12/hello-jit-world-joy-of-simple-jits.html" target="_blank" rel="noopener noreferrer">此網站<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p>The most difficult part of writing a simple JIT is encoding the instructions so they can be understood by your target CPU. For example, on x86-64, the instruction push rbp is encoded as the byte 0x55. Implementing this encoding is boring and requires reading lots of CPU manuals, so we’re going to skip that part. Instead we’ll use Mike Pall’s very nice library DynASM to handle the encoding. DynASM has a very novel approach that lets you intermix the assembly code you’re generating with the C code of your JIT, which lets you write a JIT in a very natural and readable way. It supports many CPU architectures (x86, x86-64, PowerPC, MIPS, and ARM at the time of this writing) so you’re unlikely to be limited by its hardware support. DynASM is also exceptionally small and unimposing; its entire runtime is contained in a 500-line header file.</p></blockquote> <p>就是說，JIT 最麻煩的地方，就是要編碼指令，你必須了解你環境的 CPU 指令及架構，你要去讀厚厚一本手冊 🙁，但我們今天要快速實現 JIT，DynASM 就成了我們的英雄。幫助我們做好 encoding 的工作 ( 但是還是需要懂組合語言啦... )，不過至少省了很多功夫。</p> <p>接下來我們將 JIT 利用 DynASM 動態產生 machine code 並將它放入 dasm_State (at runtime) ，最後再轉換成可執行的機器碼</p> <p>在開始前先安裝 LuaJIT，首先先下載專案</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">git</span> clone https://luajit.org/git/luajit.git
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>進到資料夾後，再下 make 安裝</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span>
<span class="token function">sudo</span>  <span class="token function">ln</span> -sf luajit-2.1.0-beta3 /usr/local/bin/luajit <span class="token comment"># 建立 symbolic 的 link，之後直接下 luajit 指令即可</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>若是不知道怎執行的，可以看<a href="https://github.com/haberman/jitdemo/blob/master/Makefile" target="_blank" rel="noopener noreferrer">本篇文章作者的Github<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的makefile 檔案。</p> <div class="language-makefile line-numbers-mode"><pre class="language-makefile"><code>CFLAGS<span class="token operator">=</span>-O3 -g -std<span class="token operator">=</span>gnu99 -Ithird_party

<span class="token target symbol">all</span><span class="token punctuation">:</span> jit1 jit2 jit3

<span class="token target symbol">jit2</span><span class="token punctuation">:</span> dynasm-driver.c jit2.h
	<span class="token variable">$</span><span class="token punctuation">(</span>CC<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>CFLAGS<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>CPPFLAGS<span class="token punctuation">)</span> -o jit2 dynasm-driver.c -DJIT<span class="token operator">=</span>\&quot;jit2.h\&quot;
<span class="token target symbol">jit2.h</span><span class="token punctuation">:</span> jit2.dasc
	lua dynasm/dynasm.lua jit2.dasc &gt; jit2.h
...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>可以看到 *.dasc 檔案用 lua 進行前處理，把混和組合語言跟 C 的 code 變成 C 語言的 header 檔案，而 <code>-DJIT</code> 是定義出現在作者寫的 <code>dynasm-driver.c</code> 的巨集</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">/*dynasm-driver.c*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;dynasm/dasm_proto.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;dynasm/dasm_x86.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">initjit</span><span class="token punctuation">(</span>dasm_State <span class="token operator">*</span><span class="token operator">*</span>state<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>actionlist<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">jitcode</span><span class="token punctuation">(</span>dasm_State <span class="token operator">*</span><span class="token operator">*</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">free_jitcode</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token expression">JIT</span></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>不論是 dynasm 函式庫，或是 <code>dynasm-driver.c</code> 的檔案，都是等等所需要的工具，如同下面這張圖
<img src="https://i.imgur.com/HoyLASQ.png" alt=""></p> <hr> <p>接下來，我們先試試看把 lua 用在 *.dasm 檔案上吧
先準備 <code>jit_dynasm.dasc</code>檔案</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token comment">// DynASM directives.</span>
<span class="token operator">|</span><span class="token punctuation">.</span>arch x64
<span class="token operator">|</span><span class="token punctuation">.</span>actionlist actions

<span class="token comment">// This define affects &quot;|&quot; DynASM lines.  &quot;Dst&quot; must</span>
<span class="token comment">// resolve to a dasm_State** that points to a dasm_State*.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Dst</span> <span class="token expression"><span class="token operator">&amp;</span>state</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;Usage: jit1 &lt;integer&gt;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dasm_State <span class="token operator">*</span>state<span class="token punctuation">;</span>
        <span class="token function">initjit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>state<span class="token punctuation">,</span> actions<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Generate the code.  Each line appends to a buffer in</span>
        <span class="token comment">// &quot;state&quot;, but the code in this buffer is not fully linked</span>
        <span class="token comment">// yet because labels can be referenced before they are</span>
        <span class="token comment">// defined.</span>
        <span class="token comment">//</span>
        <span class="token comment">// The run-time value of C variable &quot;num&quot; is substituted</span>
        <span class="token comment">// into the immediate value of the instruction.</span>
        <span class="token operator">|</span>  mov eax<span class="token punctuation">,</span> num
        <span class="token operator">|</span>  ret

        <span class="token comment">// Link the code and write it to executable memory.</span>
        <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">jitcode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Call the JIT-ted function.</span>
        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">fptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assert</span><span class="token punctuation">(</span>num <span class="token operator">==</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Free the machine code.</span>
        <span class="token function">free_jitcode</span><span class="token punctuation">(</span>fptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><ul><li><code>|</code> DynASM 的 preprocessor 會先進行處理</li> <li><code>|.arch</code> 在每一個 DynASM source file 中，必須先指定產生哪種指令集架構，如 x86 或 x64</li></ul> <p>再來下指令</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>luajit third_party/dynasm/dynasm.lua jit_dynasm.dasc <span class="token operator">&gt;</span> jit_dynasm.h
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>其中，<code>third_party/dynasm/dynasm.lua</code> 是方才<a href="https://github.com/haberman/jitdemo" target="_blank" rel="noopener noreferrer">連結<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的 dynasm 的 lua 腳本。</p> <blockquote><p>題外話，其實用一般的 lua 指令也是可以🤣，不一定要 luajit 才能 run</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> lua5.2
lua third_party/dynasm/dynasm.lua jit_dynasm.dasc <span class="token operator">&gt;</span> jit_dynasm.h
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></blockquote> <p>輸出的 header 檔 <code>jit_dynasm.h</code></p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*
** This file has been pre-processed with DynASM.
** http://luajit.org/dynasm.html
** DynASM version 1.3.0, DynASM x64 version 1.3.0
** DO NOT EDIT! The original file is in &quot;jit_dynasm.dasc&quot;.
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DASM_VERSION <span class="token operator">!=</span> <span class="token number">10300</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">error</span> <span class="token string">&quot;Version mismatch between DynASM and included encoding engine&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

# <span class="token number">1</span> <span class="token string">&quot;jit_dynasm.dasc&quot;</span>
<span class="token comment">// DynASM directives.</span>
<span class="token comment">//|.arch x64</span>
<span class="token comment">//|.actionlist actions</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> actions<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token number">184</span><span class="token punctuation">,</span><span class="token number">237</span><span class="token punctuation">,</span><span class="token number">195</span><span class="token punctuation">,</span><span class="token number">255</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

# <span class="token number">4</span> <span class="token string">&quot;jit_dynasm.dasc&quot;</span>

<span class="token comment">// This define affects &quot;|&quot; DynASM lines.  &quot;Dst&quot; must</span>
<span class="token comment">// resolve to a dasm_State** that points to a dasm_State*.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Dst</span> <span class="token expression"><span class="token operator">&amp;</span>state</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;Usage: jit1 &lt;integer&gt;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dasm_State <span class="token operator">*</span>state<span class="token punctuation">;</span>
        <span class="token function">initjit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>state<span class="token punctuation">,</span> actions<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Generate the code.  Each line appends to a buffer in</span>
        <span class="token comment">// &quot;state&quot;, but the code in this buffer is not fully linked</span>
        <span class="token comment">// yet because labels can be referenced before they are</span>
        <span class="token comment">// defined.</span>
        <span class="token comment">//</span>
        <span class="token comment">// The run-time value of C variable &quot;num&quot; is substituted</span>
        <span class="token comment">// into the immediate value of the instruction.</span>
        <span class="token comment">//|  mov eax, num</span>
        <span class="token comment">//|  ret</span>
        <span class="token function">dasm_put</span><span class="token punctuation">(</span>Dst<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
# <span class="token number">28</span> <span class="token string">&quot;jit_dynasm.dasc&quot;</span>

        <span class="token comment">// Link the code and write it to executable memory.</span>
        <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">jitcode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Call the JIT-ted function.</span>
        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">fptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assert</span><span class="token punctuation">(</span>num <span class="token operator">==</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Free the machine code.</span>
        <span class="token function">free_jitcode</span><span class="token punctuation">(</span>fptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><p>接下來進行編譯</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>clang -g -Wall -Ithird_party -o jit_dynasm dynasm-driver.c -DJIT<span class="token operator">=</span><span class="token punctuation">\</span>&quot;jit_dynasm.h<span class="token punctuation">\</span>&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>執行</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>./jit_dynasm <span class="token number">42</span> 即可
<span class="token builtin class-name">echo</span> <span class="token variable">$?</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>也可以用我的專案</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">make</span> jit_dynasm 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>即可自動化編譯</p> <blockquote><p>另外 <code>echo $?</code> 要注意值最大是 255
所以 <code>./jit_dynasm 5566</code> 會是 <code>5566 mod 256 = 190</code></p></blockquote> <hr> <p>再來解析 <code>header</code> 檔</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> actions<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token number">184</span><span class="token punctuation">,</span><span class="token number">237</span><span class="token punctuation">,</span><span class="token number">195</span><span class="token punctuation">,</span><span class="token number">255</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//|  mov eax, num</span>
<span class="token comment">//|  ret</span>
<span class="token function">dasm_put</span><span class="token punctuation">(</span>Dst<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>是什麼 ?
根據<a href="https://blog.reverberate.org/2012/12/hello-jit-world-joy-of-simple-jits.html" target="_blank" rel="noopener noreferrer">本篇文章<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><ul><li>184 – the first byte of an x86 mov eax, [immediate] instruction.</li> <li>237 – the DynASM bytecode instruction DASM_IMM_D, which indicates that the next argument to dasm_put() should be written as a four-byte value. This will complete the mov instruction.</li> <li>195 – the x86 encoding of the ret instruction.</li> <li>255 – the DynASM bytecode instruction DASM_STOP, which indicates that encoding should halt.</li></ul> <p>This action buffer is then referenced by the parts of the code that actually emit assembly instructions. These instruction-emitting lines are replaced with a call to dasm_put() that provides an offset into the action buffer and passes any runtime values that need to be substituted into the output (like our runtime value of num). dasm_put() will append these instructions (with our runtime value of num) into the buffer stored in state (see the #define Dst &amp;state define above).</p></blockquote> <p>也就是說 184 是 mov 指令，而 237 是 DynASM 的 DASM_IMM_D，表示下一個被 dasm_put() 傳進來的 value 填上 mov 的值，
而這個值就是我們 runtime 才會填上的 num。因此，有 dynasm 的幫助，可以順利完成簡單的 JIT</p> <p>最後，此專案的編譯指令</p> <p>編譯最原始的 jit (沒用 dynasm)</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">make</span> -i
<span class="token function">make</span> test_jit_toy
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>編譯 dynasm 的 jit</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">make</span> jit_dynasm
<span class="token function">make</span> test_jit_dynasm
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><hr> <h2 id="三、揉合-objdump"><a href="#三、揉合-objdump" class="header-anchor">#</a> 三、揉合 Objdump</h2> <p>剛剛最一開始的 simple jit，是直接用 machine code 寫入<strong>可執行的記憶體區段</strong>，再指定給函數指標做執行。之後又談論到JIT 較麻煩的地方，就是要編碼指令，你必須了解你環境的 CPU 指令及架構</p> <p>所以才會使用到第二章節的<code>Dynasm</code>的引擎或工具，只要利用該指令集架構的組合語言，<code>Dynasm</code>就會很友善的來幫我們生成C語言程式碼。</p> <p>不過有些人(像我)，平常鮮少碰到組合語言。可能連組合語言蠻陌生的。有組合語言的這些範例程式碼可能還沒辦法使用的駕輕就熟。因此受到<a href="https://nickdesaulniers.github.io/blog/2013/04/03/basic-jit/" target="_blank" rel="noopener noreferrer">basic-jit<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>這篇文章的啟發，可以先用其他方式來得到機器碼，進而較輕鬆實現simple JIT 的功能，<strong>暫時</strong>跳過組合語言的部分。(但以後還是要還債辣，God，人生好難 = =)</p> <p>那就是使用 <code>objdump</code>這個反組譯工具。可以先將你的函式編譯成一個<code>.o</code>檔案。之後再利用 objdump 這個工具幫你反組譯得到組合語言跟機器碼的對照，接下來就來示範一下如何使用。</p> <p>首先，先建立一個<code>mul.c</code>檔案</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">mul</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">return</span> a <span class="token operator">*</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>之後編譯成<code>.o</code>檔，再利用<code>objdump</code>這個工具反組譯</p> <p>接下來，輸入指令</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>objdump -j .text -d mul.o -M intel
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>-j</code> : 只顯示指定 section 的區域(section 的概念跟 ELF 檔案格式有關，以後會談到)
<img src="https://i.imgur.com/g3D5aIM.png" alt=""></p> <p><code>-d</code> : 你要反組譯哪個二進制檔案(*.o, 執行檔等)</p> <p><code>-M</code> : 選擇你要反組譯的指令集架構組合語言</p> <p>其他選項不贅談，可以輸入 <code>objdump -H</code> 看看</p> <p>之後得到訊息</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>mul.o:     file format elf64-x86-64

Disassembly of section .text:

0000000000000000 &lt;mul&gt;:
   0:   55                      push   rbp
   1:   48 89 e5                mov    rbp,rsp
   4:   89 7d fc                mov    DWORD PTR [rbp-0x4],edi
   7:   89 75 f8                mov    DWORD PTR [rbp-0x8],esi
   a:   8b 75 fc                mov    esi,DWORD PTR [rbp-0x4]
   d:   0f af 75 f8             imul   esi,DWORD PTR [rbp-0x8]
  11:   89 f0                   mov    eax,esi
  13:   5d                      pop    rbp
  14:   c3                      ret
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>當然，在這裡你也可以不用指定 intel 架構</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>objdump -j .text -d mul.o
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>得到</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>mul.o:     file format elf64-x86-64


Disassembly of section .text:

0000000000000000 &lt;mul&gt;:
   0:   55                      push   %rbp
   1:   48 89 e5                mov    %rsp,%rbp
   4:   89 7d fc                mov    %edi,-0x4(%rbp)
   7:   89 75 f8                mov    %esi,-0x8(%rbp)
   a:   8b 75 fc                mov    -0x4(%rbp),%esi
   d:   0f af 75 f8             imul   -0x8(%rbp),%esi
  11:   89 f0                   mov    %esi,%eax
  13:   5d                      pop    %rbp
  14:   c3                      retq
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>這個對我們很有幫助，我們得到機器碼跟它對應的組合語言，也就是說</p> <ol><li>我們可以利用機器碼完成第一部份的simple JIT</li> <li>我們也可以指定指令集架構後結合對應的組合語言跟C程式，利用方才的<code>dynasm</code> 工具幫我們進行處理</li></ol> <p>一魚兩吃 ? 不好嗎 😅，不過還是需要理解組合語言跟指令集架構的相關知識，但這個工具著實可以輔助我們更快達成目標。</p> <p>接下來就把這段 code 拿去用在第一部分跟第二部分吧~~</p> <p>首先第一部分，就是比較人工一點，把機器碼全部都輸入字元陣列內，再指定到mmap 分配的可執行記憶體區段。</p> <p><code>obj_jit_boy.c</code></p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span> <span class="token comment">// printf</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span> <span class="token comment">// memcpy</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span> <span class="token comment">// mmap, munmap</span></span>

<span class="token keyword">int</span> <span class="token function">main</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// Hexadecimal x86_64 machine code for: int mul (int a, int b) { return a * b; }</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> code <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token number">0x55</span><span class="token punctuation">,</span> <span class="token comment">// push rbp</span>
        <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x89</span><span class="token punctuation">,</span> <span class="token number">0xe5</span><span class="token punctuation">,</span> <span class="token comment">// mov rbp, rsp</span>
        <span class="token number">0x89</span><span class="token punctuation">,</span> <span class="token number">0x7d</span><span class="token punctuation">,</span> <span class="token number">0xfc</span><span class="token punctuation">,</span> <span class="token comment">// mov DWORD PTR [rbp-0x4],edi</span>
        <span class="token number">0x89</span><span class="token punctuation">,</span> <span class="token number">0x75</span><span class="token punctuation">,</span> <span class="token number">0xf8</span><span class="token punctuation">,</span> <span class="token comment">// mov DWORD PTR [rbp-0x8],esi</span>
        <span class="token number">0x8b</span><span class="token punctuation">,</span> <span class="token number">0x75</span><span class="token punctuation">,</span> <span class="token number">0xfc</span><span class="token punctuation">,</span> <span class="token comment">// mov esi,DWORD PTR [rbp-04x]</span>
        <span class="token number">0x0f</span><span class="token punctuation">,</span> <span class="token number">0xaf</span><span class="token punctuation">,</span> <span class="token number">0x75</span><span class="token punctuation">,</span> <span class="token number">0xf8</span><span class="token punctuation">,</span> <span class="token comment">// imul esi,DWORD PTR [rbp-0x8]</span>
        <span class="token number">0x89</span><span class="token punctuation">,</span> <span class="token number">0xf0</span><span class="token punctuation">,</span> <span class="token comment">// mov eax,esi</span>
        <span class="token number">0x5d</span><span class="token punctuation">,</span> <span class="token comment">// pop rbp</span>
        <span class="token number">0xc3</span> <span class="token comment">// ret</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// allocate executable memory via sys call</span>
        <span class="token keyword">void</span><span class="token operator">*</span> mem <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">,</span> PROT_WRITE <span class="token operator">|</span> PROT_EXEC<span class="token punctuation">,</span>
                        MAP_ANON <span class="token operator">|</span> MAP_PRIVATE<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// copy runtime code into allocated memory</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> code<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// typecast allocated memory to a function pointer</span>
        <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> mem<span class="token punctuation">;</span>

        <span class="token comment">// call function pointer</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d * %d = %d\n&quot;</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Free up allocated memory</span>
        <span class="token function">munmap</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>再來第二部分，結合組合語言到 dynasm 的方法，這邊要注意幾點</p> <ul><li>注意指令及架構</li> <li>不能把剛剛objdump的組語直接複製貼上</li></ul> <blockquote><p>關於第二點我試過，執行時堆疊的 push 跟 pop 可能dynasm 幫你做了，dynasm 可能要讓你的組語專注在函式功能本身 ? (這點待確認)</p></blockquote> <p>原本</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>|  push   rbp
|  mov    rbp, rsp
|  mov    dword [rbp-0x4], edi
|  mov    dword [rbp-0x8], esi 
|  mov    esi, dword [rbp-0x4] 
|  imul   esi, dword [rbp-0x8]  
|  mov    eax,esi
|  pop    rbp
|  ret
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>稍微修改</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//|  push   rbp
//|  mov    rsp, rbp
|  mov    dword [rsp-0x4], edi
|  mov    dword [rsp-0x8], esi 
|  mov    esi, dword [rsp-0x4] 
|  imul   esi, dword [rsp-0x8]  
|  mov    eax,esi
|  ret
//|  pop    rbp
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token comment">// DynASM directives.</span>
<span class="token operator">|</span><span class="token punctuation">.</span>arch x64
<span class="token operator">|</span><span class="token punctuation">.</span>actionlist actions

<span class="token comment">// This define affects &quot;|&quot; DynASM lines.  &quot;Dst&quot; must</span>
<span class="token comment">// resolve to a dasm_State** that points to a dasm_State*.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Dst</span> <span class="token expression"><span class="token operator">&amp;</span>state</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
        dasm_State <span class="token operator">*</span>state<span class="token punctuation">;</span>
        <span class="token function">initjit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>state<span class="token punctuation">,</span> actions<span class="token punctuation">)</span><span class="token punctuation">;</span>

        
        <span class="token operator">|</span>  mov    dword <span class="token punctuation">[</span>rsp<span class="token operator">-</span><span class="token number">0x4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> edi
        <span class="token operator">|</span>  mov    dword <span class="token punctuation">[</span>rsp<span class="token operator">-</span><span class="token number">0x8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> esi 
        <span class="token operator">|</span>  mov    esi<span class="token punctuation">,</span> dword <span class="token punctuation">[</span>rsp<span class="token operator">-</span><span class="token number">0x4</span><span class="token punctuation">]</span> 
        <span class="token operator">|</span>  imul   esi<span class="token punctuation">,</span> dword <span class="token punctuation">[</span>rsp<span class="token operator">-</span><span class="token number">0x8</span><span class="token punctuation">]</span>  
        <span class="token operator">|</span>  mov    eax<span class="token punctuation">,</span>esi
        <span class="token operator">|</span>  ret

        <span class="token comment">// Link the code and write it to executable memory.</span>
        <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">jitcode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
        

        <span class="token comment">// Call the JIT-ted function.</span>
        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">fptr</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d * %d = %d\n&quot;</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Free the machine code.</span>
        <span class="token function">free_jitcode</span><span class="token punctuation">(</span>fptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><hr> <h2 id="四、part-1-總結"><a href="#四、part-1-總結" class="header-anchor">#</a> 四、Part 1 總結</h2> <p>在 Part 1，我們實做了下列幾種方法</p> <ul><li><p>第一部分: 直接把機器碼放進 mmap 可執行記憶體區段執行，困難的點是要先知道功能對應的機器碼</p></li> <li><p>第二部分: 利用 dynasm code generator 幫助我們生成機器碼，困難的點是要熟悉 dynasm 怎麼用，以及需要先具備一些組語的知識</p></li> <li><p>第三部分: 我們利用稍微繞遠路的方式，先編譯函數，再用 objdump 反組譯得到機器碼跟組合語言，可以稍微改善前面兩部分的困難的點</p></li></ul> <p>但是要學編譯器跟 JIT，組合語言的知識遲早都得補完🤣</p> <hr> <h2 id="五、專案執行方式"><a href="#五、專案執行方式" class="header-anchor">#</a> 五、專案執行方式</h2> <ol><li>執行第一部份的 Simple JIT</li></ol> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">make</span> jit_toy<span class="token punctuation">;</span> ./jittoy <span class="token number">56</span><span class="token punctuation">;</span> <span class="token builtin class-name">echo</span> <span class="token variable">$?</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>記得測試整數 <strong>&lt;=255</strong>，因為程式回傳狀態只有 8 bits，小心溢位會出現 mod 256 的結果</p> <ol start="2"><li>執行第二部份的 dynasm JIT</li></ol> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">make</span> jit_dynasm<span class="token punctuation">;</span> ./jit_dynasm <span class="token number">56</span><span class="token punctuation">;</span> <span class="token builtin class-name">echo</span> <span class="token variable">$?</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="3"><li>執行第三部份的 objdump + simple JIT</li></ol> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">make</span> clean<span class="token punctuation">;</span> <span class="token function">make</span> obj_jit_toy<span class="token punctuation">;</span> ./obj_jit_toy
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="4"><li>執行第三部份的 objdump + obj_jit_dynasm</li></ol> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">make</span> clean<span class="token punctuation">;</span> <span class="token function">make</span> obj_jit_dynasm<span class="token punctuation">;</span> ./obj_jit_dynasm
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><hr> <h1 id="參考網站"><a href="#參考網站" class="header-anchor">#</a> 參考網站</h1> <ol><li><p><a href="https://blog.reverberate.org/2012/12/hello-jit-world-joy-of-simple-jits.html" target="_blank" rel="noopener noreferrer">Hello, JIT World: The Joy of Simple JITs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://github.com/jserv/jit-construct" target="_blank" rel="noopener noreferrer">必讀 : interpreter-compiler-jit<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://www.zhihu.com/question/54748092/answer/141903877" target="_blank" rel="noopener noreferrer">有哪些常用 JIT 算法？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="http://accu.cc/content/jit_tour/brainfuck_interpreter/" target="_blank" rel="noopener noreferrer">JIT 編譯器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://github.com/haberman/jitdemo" target="_blank" rel="noopener noreferrer">jitdemo 的 github <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://nickdesaulniers.github.io/blog/2013/04/03/basic-jit/" target="_blank" rel="noopener noreferrer">basic-jit<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ol> <h1 id="延伸閱讀"><a href="#延伸閱讀" class="header-anchor">#</a> 延伸閱讀</h1> <ol><li><p><a href="https://www.youtube.com/watch?v=2BB39q6cqPQ&amp;t=905s" target="_blank" rel="noopener noreferrer">Matthew Page - How to JIT: Writing a Python JIT from scratch in pure Python - PyCon 2019<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li>python 在寫較底層(mmap, memmove, peachpy)等，中間的坑不少。使用這些套件會牽涉到 windows 和 unix-like 系統的因素而有所不同，所以想要改成使用 C 語言</li></ul></li> <li><p><a href="https://github.com/Maratyszcza/PeachPy" target="_blank" rel="noopener noreferrer">PeachPy-類似 dynasm 一樣的套件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://github.com/dolphindb/Tutorials_CN/blob/master/jit.md" target="_blank" rel="noopener noreferrer">DolphinDB JIT教程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ol></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">Tue Jul 06 2021 19:28:11 GMT+0800</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/coding-hub/blogs/Just_in_time_compiler/JIT.html" class="prev">
            Just In Time Compiler - Part 0. 專案說明與綜觀介紹
          </a></span> <span class="next"><a href="/coding-hub/blogs/Just_in_time_compiler/Part2.html">
            Just In Time Compiler - Part 2. Brainfuck compiler and Interpreter
          </a></span></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:0;" data-v-70334359></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><!----><!----><div class="vuepress-canvas-nest-element"></div><canvas id="vuepress-canvas-cursor"></canvas></div></div>
    <script src="/coding-hub/assets/js/app.df64d80b.js" defer></script><script src="/coding-hub/assets/js/6.5a677154.js" defer></script><script src="/coding-hub/assets/js/1.0bfbaed9.js" defer></script><script src="/coding-hub/assets/js/23.0e9db64a.js" defer></script><script src="/coding-hub/assets/js/11.c55c4bcd.js" defer></script>
  </body>
</html>
