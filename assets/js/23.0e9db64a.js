(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{794:function(s,a,t){"use strict";t.r(a);var n=t(5),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"part-1-èªè­˜-jit-åŠå»ºç«‹ç°¡å–®çš„-jit"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#part-1-èªè­˜-jit-åŠå»ºç«‹ç°¡å–®çš„-jit"}},[s._v("#")]),s._v(" Part 1. èªè­˜ JIT åŠå»ºç«‹ç°¡å–®çš„(?) JIT")]),s._v(" "),t("h2",{attrs:{id:"ä¸€ã€just-in-time-çš„æ¦‚å¿µ"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ä¸€ã€just-in-time-çš„æ¦‚å¿µ"}},[s._v("#")]),s._v(" ä¸€ã€Just-in-time çš„æ¦‚å¿µ")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("ä½¿ç”¨åˆ°çš„å¤§å°ˆæ¡ˆ : Google V8, Java Virtual Machine, C# Framework, RubyJIT, pypy, numba, DolphinDB ç­‰")])]),s._v(" "),t("li",[t("p",[s._v("å‹•æ…‹ç·¨è­¯æŠ€è¡“ (æ··åˆå‹ç·¨è­¯-çµåˆ compiler and interpreter)")])]),s._v(" "),t("li",[t("p",[s._v("Interpretor åŸ·è¡Œçš„æ™‚å€™ï¼Œæœƒç›£çœ‹å“ªæ®µç¨‹å¼ç¢¼æ˜¯ç†±é»(hot)ç¨‹å¼ç¢¼ï¼Œä¾‹å¦‚è¿´åœˆã€‚ç™¼ç¾å¾Œé¦¬ä¸Šé€åˆ° JIT ç·¨è­¯æˆæ©Ÿå™¨ç¢¼æ”¾åœ¨è¨˜æ†¶é«”ï¼Œä¸‹æ¬¡åŸ·è¡Œæ™‚ä¸ç”¨é‡æ–°ç¿»è­¯ï¼Œé¡ä¼¼å¿«å–çš„æ¦‚å¿µ")])]),s._v(" "),t("li",[t("p",[s._v("å„ªé»æ˜¯ï¼Œå¯ä»¥å¾—åˆ°éœæ…‹ç·¨è­¯æ‰€æ²’æœ‰çš„è¨Šæ¯ï¼ŒçŸ¥é“å“ªäº›å‡½æ•¸æ˜¯ä¸æ˜¯è¢«å¤§é‡ä½¿ç”¨çš„ï¼Œæˆ–æ˜¯é‚£äº›å‡½æ•¸çš„åƒæ•¸ä¸€ç›´éƒ½æ²’æœ‰è®Šç­‰ç­‰ã€‚ä¸€æ—¦å¾—åˆ°é€™äº›è¨Šæ¯ï¼Œå¯ä»¥ç·¨è­¯å‡ºæ¯”éœæ…‹ç·¨è­¯å™¨æ›´å¥½çš„æ©Ÿå™¨ç¢¼ã€‚ä¸€èˆ¬ç¨‹å¼ä¹Ÿæ˜¯ 90-10 åŸå‰‡ã€‚åŸ·è¡Œæ™‚ 90% çš„è¨ˆç®—æ™‚é–“æ˜¯è·‘ 10% çš„ç¨‹å¼ç¢¼ï¼Œåªè¦æ‰¾åˆ°é€™äº›ç†±é»(hot-spot) ç¨‹å¼ç¢¼ï¼Œå°±èƒ½é€²è¡Œæ›´æ·±åº¦çš„å„ªåŒ–")])]),s._v(" "),t("li",[t("p",[s._v("ç¼ºé»æ˜¯")]),s._v(" "),t("ul",[t("li",[s._v("ç›£çœ‹æœƒè€—è²»CPUè³‡æº")]),s._v(" "),t("li",[s._v("å„²å­˜ç¨‹å¼ç¢¼æœƒè€—è²»è¨˜æ†¶é«”ç©ºé–“")]),s._v(" "),t("li",[s._v("åœ¨ runtime ç”¢ç”Ÿ codeï¼Œæ¯æ¬¡é‡æ–°å•Ÿå‹•æ™‚åˆè¦é‡æ–°ç›£æ§(profiling)ä¸€æ¬¡ï¼Œæ²’æœ‰ç•™ç´€éŒ„ï¼ŒAOT (ahead-of-time) æ”¹å–„æ­¤ç¼ºé»")])])])]),s._v(" "),t("h2",{attrs:{id:"äºŒã€-hello-jit-world-the-joy-of-simple-jits"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#äºŒã€-hello-jit-world-the-joy-of-simple-jits"}},[s._v("#")]),s._v(" äºŒã€ Hello, JIT World: The Joy of Simple JITs")]),s._v(" "),t("p",[s._v("é€™æ˜¯æœ€ç°¡å–®çš„ jit ç¯„ä¾‹ï¼Œä¸‹é¢ç”¨ mmap å»ºç«‹ä¸€å¡Šå¯å¯«å¯åŸ·è¡Œçš„å€åŸŸï¼Œä½†æ˜¯ä¸€èˆ¬æœ€å¥½ä¸è¦ç”¨å¯åŸ·è¡Œçš„flagï¼Œå› ç‚ºå¯èƒ½æœƒæœ‰å®‰å…¨ä¸Šçš„å•é¡Œã€‚é€™ä¹Ÿæ˜¯ç‚ºä»€éº¼ä¸ç”¨ malloc å»å®£å‘Šä¸€å¡Šè¨˜æ†¶é«”ï¼Œå› ç‚ºheap, stack éƒ½æ˜¯ä¸å¯åŸ·è¡Œçš„è¨˜æ†¶é«”å€å¡Šã€‚")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://blog.reverberate.org/2012/12/hello-jit-world-joy-of-simple-jits.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("é€™å€‹ç¶²ç«™"),t("OutboundLink")],1),s._v(" ä¹Ÿæåˆ°")]),s._v(" "),t("blockquote",[t("p",[s._v("You might wonder why you canâ€™t call a function that just changes the permissions of the memory you get from malloc(). Having to allocate executable memory in a totally different way sounds like a drag. In fact there is a function that can change permissions on memory you already have; itâ€™s called mprotect(). But these permissions can only be set on page boundaries; malloc() will give you some memory from the middle of a page, a page that you do not own in its entirety. If you start changing permissions on that page youâ€™ll affect any other code that might be using memory in that page.")])]),s._v(" "),t("p",[s._v("æ„æ€å°±æ˜¯èªªï¼Œå¯ä»¥ç”¨ mprotect æ”¹è®Š malloc çš„æ¬Šé™ï¼Œä½†æ˜¯æ˜¯ä»¥"),t("code",[s._v("é ")]),s._v(" ç‚ºå–®ä½è¨­æ¬Šé™ï¼Œè€Œä¸æ˜¯åªé‡å° malloc åˆ†é…å‡ºä¾†çš„è¨˜æ†¶é«”å€å¡Šã€‚å› æ­¤ï¼Œå¦‚æœåªé‡å° malloc é€²è¡Œ mprotectï¼Œå¯èƒ½æœƒæ”¹è®Šåˆ°å…¶ä»–ä½¿ç”¨åˆ°é€™å€‹ page çš„æŒ‡ä»¤æˆ–æ˜¯ code")]),s._v(" "),t("div",{staticClass:"language-C line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* jit_toy.c */")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" argc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" argv"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Machine code for:")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//   mov eax, 0")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//   ret")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("unsigned")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),s._v(" code"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0xb8")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x00")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x00")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x00")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x00")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0xc3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("argc "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("fprintf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("stderr")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Usage: jit1 <integer>\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// Overwrite immediate value "0" in the instruction')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// with the user's value.  This will make our code:")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//   mov eax, <user's value>")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//   ret")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" num "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("atoi")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("argv"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("memcpy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("code"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("num"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Allocate writable/executable memory.")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Note: real programs should not map memory both writable")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// and executable because it is a security risk.")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("mem "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mmap")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NULL")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("sizeof")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("code"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" PROT_WRITE "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" PROT_EXEC"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                        MAP_ANON "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" MAP_PRIVATE"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("memcpy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("mem"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" code"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("sizeof")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("code"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// The function will return the user's value.")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("func"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" mem"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("func")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br")])]),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" ./jit_toy "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("55")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$?")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"äºŒã€hello-dynasm-world"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#äºŒã€hello-dynasm-world"}},[s._v("#")]),s._v(" äºŒã€Hello, DynASM World!")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://luajit.org/dynasm.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("DynASM å®˜æ–¹ç¶²é "),t("OutboundLink")],1),s._v("ï¼Œç‰¹è‰²å¦‚ä¸‹")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("DynASM æ˜¯ä¸€å€‹ç¨‹å¼ç¢¼ç”Ÿæˆçš„å‹•æ…‹çµ„è­¯å™¨(code generator)")])]),s._v(" "),t("li",[t("p",[s._v("ç‚º "),t("code",[s._v("LuaJIT")]),s._v(" é–‹ç™¼ä¸»è¦å·¥å…·")])]),s._v(" "),t("li",[t("p",[s._v("DynASM é©ç”¨ä»¥ä¸‹æƒ…å¢ƒ")]),s._v(" "),t("ul",[t("li",[s._v("æ’°å¯«ä¸€å€‹ JIT compiler <------ æˆ‘å€‘è¦çš„ ^__^")]),s._v(" "),t("li",[s._v("å¿«é€Ÿç”Ÿæˆç¨‹å¼ç¢¼ (é«˜æ•ˆèƒ½çš„è¨ˆç®—)")])])]),s._v(" "),t("li",[t("p",[s._v("DynASM æŠŠæ··åˆ C/Assembler code è½‰æˆ C code.")])]),s._v(" "),t("li",[t("p",[s._v("æ”¯æ´ x86, x64, ARM, ARM64, PowerPC and MIPS æŒ‡ä»¤é›†æ¶æ§‹")])]),s._v(" "),t("li",[t("p",[t("a",{attrs:{href:"https://luajit.org/dynasm_features.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("å…¶ä»–ç‰¹è‰²"),t("OutboundLink")],1)])])]),s._v(" "),t("p",[s._v("å° dynasm æœ‰äº›åˆæ­¥çš„èªè­˜å¾Œï¼Œé‚£ç‚ºä»€éº¼è¦ä½¿ç”¨ dynasm å‘¢ ?\nç¯€éŒ„è‡³"),t("a",{attrs:{href:"https://blog.reverberate.org/2012/12/hello-jit-world-joy-of-simple-jits.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("æ­¤ç¶²ç«™"),t("OutboundLink")],1)]),s._v(" "),t("blockquote",[t("p",[s._v("The most difficult part of writing a simple JIT is encoding the instructions so they can be understood by your target CPU. For example, on x86-64, the instruction push rbp is encoded as the byte 0x55. Implementing this encoding is boring and requires reading lots of CPU manuals, so weâ€™re going to skip that part. Instead weâ€™ll use Mike Pallâ€™s very nice library DynASM to handle the encoding. DynASM has a very novel approach that lets you intermix the assembly code youâ€™re generating with the C code of your JIT, which lets you write a JIT in a very natural and readable way. It supports many CPU architectures (x86, x86-64, PowerPC, MIPS, and ARM at the time of this writing) so youâ€™re unlikely to be limited by its hardware support. DynASM is also exceptionally small and unimposing; its entire runtime is contained in a 500-line header file.")])]),s._v(" "),t("p",[s._v("å°±æ˜¯èªªï¼ŒJIT æœ€éº»ç…©çš„åœ°æ–¹ï¼Œå°±æ˜¯è¦ç·¨ç¢¼æŒ‡ä»¤ï¼Œä½ å¿…é ˆäº†è§£ä½ ç’°å¢ƒçš„ CPU æŒ‡ä»¤åŠæ¶æ§‹ï¼Œä½ è¦å»è®€åšåšä¸€æœ¬æ‰‹å†Š ğŸ™ï¼Œä½†æˆ‘å€‘ä»Šå¤©è¦å¿«é€Ÿå¯¦ç¾ JITï¼ŒDynASM å°±æˆäº†æˆ‘å€‘çš„è‹±é›„ã€‚å¹«åŠ©æˆ‘å€‘åšå¥½ encoding çš„å·¥ä½œ ( ä½†æ˜¯é‚„æ˜¯éœ€è¦æ‡‚çµ„åˆèªè¨€å•¦... )ï¼Œä¸éè‡³å°‘çœäº†å¾ˆå¤šåŠŸå¤«ã€‚")]),s._v(" "),t("p",[s._v("æ¥ä¸‹ä¾†æˆ‘å€‘å°‡ JIT åˆ©ç”¨ DynASM å‹•æ…‹ç”¢ç”Ÿ machine code ä¸¦å°‡å®ƒæ”¾å…¥ dasm_State (at runtime) ï¼Œæœ€å¾Œå†è½‰æ›æˆå¯åŸ·è¡Œçš„æ©Ÿå™¨ç¢¼")]),s._v(" "),t("p",[s._v("åœ¨é–‹å§‹å‰å…ˆå®‰è£ LuaJITï¼Œé¦–å…ˆå…ˆä¸‹è¼‰å°ˆæ¡ˆ")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone https://luajit.org/git/luajit.git\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("é€²åˆ°è³‡æ–™å¤¾å¾Œï¼Œå†ä¸‹ make å®‰è£")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ln")]),s._v(" -sf luajit-2.1.0-beta3 /usr/local/bin/luajit "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# å»ºç«‹ symbolic çš„ linkï¼Œä¹‹å¾Œç›´æ¥ä¸‹ luajit æŒ‡ä»¤å³å¯")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("è‹¥æ˜¯ä¸çŸ¥é“æ€åŸ·è¡Œçš„ï¼Œå¯ä»¥çœ‹"),t("a",{attrs:{href:"https://github.com/haberman/jitdemo/blob/master/Makefile",target:"_blank",rel:"noopener noreferrer"}},[s._v("æœ¬ç¯‡æ–‡ç« ä½œè€…çš„Github"),t("OutboundLink")],1),s._v("çš„makefile æª”æ¡ˆã€‚")]),s._v(" "),t("div",{staticClass:"language-makefile line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-makefile"}},[t("code",[s._v("CFLAGS"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("-O3 -g -std"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("gnu99 -Ithird_party\n\n"),t("span",{pre:!0,attrs:{class:"token target symbol"}},[s._v("all")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" jit1 jit2 jit3\n\n"),t("span",{pre:!0,attrs:{class:"token target symbol"}},[s._v("jit2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" dynasm-driver.c jit2.h\n\t"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CC"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CFLAGS"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CPPFLAGS"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" -o jit2 dynasm-driver.c -DJIT"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v('\\"jit2.h\\"\n'),t("span",{pre:!0,attrs:{class:"token target symbol"}},[s._v("jit2.h")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" jit2.dasc\n\tlua dynasm/dynasm.lua jit2.dasc > jit2.h\n...\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("å¯ä»¥çœ‹åˆ° *.dasc æª”æ¡ˆç”¨ lua é€²è¡Œå‰è™•ç†ï¼ŒæŠŠæ··å’Œçµ„åˆèªè¨€è·Ÿ C çš„ code è®Šæˆ C èªè¨€çš„ header æª”æ¡ˆï¼Œè€Œ "),t("code",[s._v("-DJIT")]),s._v(" æ˜¯å®šç¾©å‡ºç¾åœ¨ä½œè€…å¯«çš„ "),t("code",[s._v("dynasm-driver.c")]),s._v(" çš„å·¨é›†")]),s._v(" "),t("div",{staticClass:"language-C line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*dynasm-driver.c*/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dynasm/dasm_proto.h"')])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dynasm/dasm_x86.h"')])]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("initjit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("dasm_State "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("state"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("actionlist"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("jitcode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("dasm_State "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("state"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("free_jitcode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("code"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token expression"}},[s._v("JIT")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("p",[s._v("ä¸è«–æ˜¯ dynasm å‡½å¼åº«ï¼Œæˆ–æ˜¯ "),t("code",[s._v("dynasm-driver.c")]),s._v(" çš„æª”æ¡ˆï¼Œéƒ½æ˜¯ç­‰ç­‰æ‰€éœ€è¦çš„å·¥å…·ï¼Œå¦‚åŒä¸‹é¢é€™å¼µåœ–\n"),t("img",{attrs:{src:"https://i.imgur.com/HoyLASQ.png",alt:""}})]),s._v(" "),t("hr"),s._v(" "),t("p",[s._v("æ¥ä¸‹ä¾†ï¼Œæˆ‘å€‘å…ˆè©¦è©¦çœ‹æŠŠ lua ç”¨åœ¨ *.dasm æª”æ¡ˆä¸Šå§\nå…ˆæº–å‚™ "),t("code",[s._v("jit_dynasm.dasc")]),s._v("æª”æ¡ˆ")]),s._v(" "),t("div",{staticClass:"language-C line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// DynASM directives.")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("arch x64\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("actionlist actions\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// This define affects "|" DynASM lines.  "Dst" must')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// resolve to a dasm_State** that points to a dasm_State*.")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("Dst")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("state")])]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" argc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("argv"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("argc "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("fprintf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("stderr")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Usage: jit1 <integer>\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" num "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("atoi")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("argv"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        dasm_State "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("state"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("initjit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("state"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" actions"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Generate the code.  Each line appends to a buffer in")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "state", but the code in this buffer is not fully linked')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// yet because labels can be referenced before they are")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// defined.")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// The run-time value of C variable "num" is substituted')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// into the immediate value of the instruction.")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("  mov eax"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" num\n        "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("  ret\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Link the code and write it to executable memory.")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("fptr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("jitcode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("state"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Call the JIT-ted function.")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" ret "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("fptr")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("assert")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("num "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" ret"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Free the machine code.")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("free_jitcode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("fptr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" ret"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br")])]),t("ul",[t("li",[t("code",[s._v("|")]),s._v(" DynASM çš„ preprocessor æœƒå…ˆé€²è¡Œè™•ç†")]),s._v(" "),t("li",[t("code",[s._v("|.arch")]),s._v(" åœ¨æ¯ä¸€å€‹ DynASM source file ä¸­ï¼Œå¿…é ˆå…ˆæŒ‡å®šç”¢ç”Ÿå“ªç¨®æŒ‡ä»¤é›†æ¶æ§‹ï¼Œå¦‚ x86 æˆ– x64")])]),s._v(" "),t("p",[s._v("å†ä¾†ä¸‹æŒ‡ä»¤")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("luajit third_party/dynasm/dynasm.lua jit_dynasm.dasc "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" jit_dynasm.h\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("å…¶ä¸­ï¼Œ"),t("code",[s._v("third_party/dynasm/dynasm.lua")]),s._v(" æ˜¯æ–¹æ‰"),t("a",{attrs:{href:"https://github.com/haberman/jitdemo",target:"_blank",rel:"noopener noreferrer"}},[s._v("é€£çµ"),t("OutboundLink")],1),s._v(" çš„ dynasm çš„ lua è…³æœ¬ã€‚")]),s._v(" "),t("blockquote",[t("p",[s._v("é¡Œå¤–è©±ï¼Œå…¶å¯¦ç”¨ä¸€èˆ¬çš„ lua æŒ‡ä»¤ä¹Ÿæ˜¯å¯ä»¥ğŸ¤£ï¼Œä¸ä¸€å®šè¦ luajit æ‰èƒ½ run")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" lua5.2\nlua third_party/dynasm/dynasm.lua jit_dynasm.dasc "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" jit_dynasm.h\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])])]),s._v(" "),t("p",[s._v("è¼¸å‡ºçš„ header æª” "),t("code",[s._v("jit_dynasm.h")])]),s._v(" "),t("div",{staticClass:"language-C line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('/*\n** This file has been pre-processed with DynASM.\n** http://luajit.org/dynasm.html\n** DynASM version 1.3.0, DynASM x64 version 1.3.0\n** DO NOT EDIT! The original file is in "jit_dynasm.dasc".\n*/')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token expression"}},[s._v("DASM_VERSION "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10300")])])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("error")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Version mismatch between DynASM and included encoding engine"')])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("endif")])]),s._v("\n\n# "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"jit_dynasm.dasc"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// DynASM directives.")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//|.arch x64")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//|.actionlist actions")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("unsigned")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),s._v(" actions"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("184")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("237")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("195")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("255")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n# "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"jit_dynasm.dasc"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// This define affects "|" DynASM lines.  "Dst" must')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// resolve to a dasm_State** that points to a dasm_State*.")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("Dst")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("state")])]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" argc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("argv"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("argc "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("fprintf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("stderr")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Usage: jit1 <integer>\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" num "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("atoi")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("argv"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        dasm_State "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("state"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("initjit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("state"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" actions"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Generate the code.  Each line appends to a buffer in")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "state", but the code in this buffer is not fully linked')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// yet because labels can be referenced before they are")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// defined.")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// The run-time value of C variable "num" is substituted')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// into the immediate value of the instruction.")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//|  mov eax, num")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//|  ret")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dasm_put")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Dst"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" num"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n# "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"jit_dynasm.dasc"')]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Link the code and write it to executable memory.")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("fptr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("jitcode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("state"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Call the JIT-ted function.")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" ret "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("fptr")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("assert")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("num "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" ret"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Free the machine code.")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("free_jitcode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("fptr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" ret"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br")])]),t("p",[s._v("æ¥ä¸‹ä¾†é€²è¡Œç·¨è­¯")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("clang -g -Wall -Ithird_party -o jit_dynasm dynasm-driver.c -DJIT"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v('"jit_dynasm.h'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v('"\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("åŸ·è¡Œ")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("./jit_dynasm "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v(" å³å¯\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$?")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("ä¹Ÿå¯ä»¥ç”¨æˆ‘çš„å°ˆæ¡ˆ")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" jit_dynasm \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("å³å¯è‡ªå‹•åŒ–ç·¨è­¯")]),s._v(" "),t("blockquote",[t("p",[s._v("å¦å¤– "),t("code",[s._v("echo $?")]),s._v(" è¦æ³¨æ„å€¼æœ€å¤§æ˜¯ 255\næ‰€ä»¥ "),t("code",[s._v("./jit_dynasm 5566")]),s._v(" æœƒæ˜¯ "),t("code",[s._v("5566 mod 256 = 190")])])]),s._v(" "),t("hr"),s._v(" "),t("p",[s._v("å†ä¾†è§£æ "),t("code",[s._v("header")]),s._v(" æª”")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("unsigned")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),s._v(" actions"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("184")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("237")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("195")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("255")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//|  mov eax, num")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//|  ret")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dasm_put")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Dst"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" num"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("æ˜¯ä»€éº¼ ?\næ ¹æ“š"),t("a",{attrs:{href:"https://blog.reverberate.org/2012/12/hello-jit-world-joy-of-simple-jits.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("æœ¬ç¯‡æ–‡ç« "),t("OutboundLink")],1)]),s._v(" "),t("blockquote",[t("ul",[t("li",[s._v("184 â€“ the first byte of an x86 mov eax, [immediate] instruction.")]),s._v(" "),t("li",[s._v("237 â€“ the DynASM bytecode instruction DASM_IMM_D, which indicates that the next argument to dasm_put() should be written as a four-byte value. This will complete the mov instruction.")]),s._v(" "),t("li",[s._v("195 â€“ the x86 encoding of the ret instruction.")]),s._v(" "),t("li",[s._v("255 â€“ the DynASM bytecode instruction DASM_STOP, which indicates that encoding should halt.")])]),s._v(" "),t("p",[s._v("This action buffer is then referenced by the parts of the code that actually emit assembly instructions. These instruction-emitting lines are replaced with a call to dasm_put() that provides an offset into the action buffer and passes any runtime values that need to be substituted into the output (like our runtime value of num). dasm_put() will append these instructions (with our runtime value of num) into the buffer stored in state (see the #define Dst &state define above).")])]),s._v(" "),t("p",[s._v("ä¹Ÿå°±æ˜¯èªª 184 æ˜¯ mov æŒ‡ä»¤ï¼Œè€Œ 237 æ˜¯ DynASM çš„ DASM_IMM_Dï¼Œè¡¨ç¤ºä¸‹ä¸€å€‹è¢« dasm_put() å‚³é€²ä¾†çš„ value å¡«ä¸Š mov çš„å€¼ï¼Œ\nè€Œé€™å€‹å€¼å°±æ˜¯æˆ‘å€‘ runtime æ‰æœƒå¡«ä¸Šçš„ numã€‚å› æ­¤ï¼Œæœ‰ dynasm çš„å¹«åŠ©ï¼Œå¯ä»¥é †åˆ©å®Œæˆç°¡å–®çš„ JIT")]),s._v(" "),t("p",[s._v("æœ€å¾Œï¼Œæ­¤å°ˆæ¡ˆçš„ç·¨è­¯æŒ‡ä»¤")]),s._v(" "),t("p",[s._v("ç·¨è­¯æœ€åŸå§‹çš„ jit (æ²’ç”¨ dynasm)")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" -i\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" test_jit_toy\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("ç·¨è­¯ dynasm çš„ jit")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" jit_dynasm\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" test_jit_dynasm\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("hr"),s._v(" "),t("h2",{attrs:{id:"ä¸‰ã€æ‰åˆ-objdump"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ä¸‰ã€æ‰åˆ-objdump"}},[s._v("#")]),s._v(" ä¸‰ã€æ‰åˆ Objdump")]),s._v(" "),t("p",[s._v("å‰›å‰›æœ€ä¸€é–‹å§‹çš„ simple jitï¼Œæ˜¯ç›´æ¥ç”¨ machine code å¯«å…¥"),t("strong",[s._v("å¯åŸ·è¡Œçš„è¨˜æ†¶é«”å€æ®µ")]),s._v("ï¼Œå†æŒ‡å®šçµ¦å‡½æ•¸æŒ‡æ¨™åšåŸ·è¡Œã€‚ä¹‹å¾Œåˆè«‡è«–åˆ°JIT è¼ƒéº»ç…©çš„åœ°æ–¹ï¼Œå°±æ˜¯è¦ç·¨ç¢¼æŒ‡ä»¤ï¼Œä½ å¿…é ˆäº†è§£ä½ ç’°å¢ƒçš„ CPU æŒ‡ä»¤åŠæ¶æ§‹")]),s._v(" "),t("p",[s._v("æ‰€ä»¥æ‰æœƒä½¿ç”¨åˆ°ç¬¬äºŒç« ç¯€çš„"),t("code",[s._v("Dynasm")]),s._v("çš„å¼•æ“æˆ–å·¥å…·ï¼Œåªè¦åˆ©ç”¨è©²æŒ‡ä»¤é›†æ¶æ§‹çš„çµ„åˆèªè¨€ï¼Œ"),t("code",[s._v("Dynasm")]),s._v("å°±æœƒå¾ˆå‹å–„çš„ä¾†å¹«æˆ‘å€‘ç”ŸæˆCèªè¨€ç¨‹å¼ç¢¼ã€‚")]),s._v(" "),t("p",[s._v("ä¸éæœ‰äº›äºº(åƒæˆ‘)ï¼Œå¹³å¸¸é®®å°‘ç¢°åˆ°çµ„åˆèªè¨€ã€‚å¯èƒ½é€£çµ„åˆèªè¨€è »é™Œç”Ÿçš„ã€‚æœ‰çµ„åˆèªè¨€çš„é€™äº›ç¯„ä¾‹ç¨‹å¼ç¢¼å¯èƒ½é‚„æ²’è¾¦æ³•ä½¿ç”¨çš„é§•è¼•å°±ç†Ÿã€‚å› æ­¤å—åˆ°"),t("a",{attrs:{href:"https://nickdesaulniers.github.io/blog/2013/04/03/basic-jit/",target:"_blank",rel:"noopener noreferrer"}},[s._v("basic-jit"),t("OutboundLink")],1),s._v("é€™ç¯‡æ–‡ç« çš„å•Ÿç™¼ï¼Œå¯ä»¥å…ˆç”¨å…¶ä»–æ–¹å¼ä¾†å¾—åˆ°æ©Ÿå™¨ç¢¼ï¼Œé€²è€Œè¼ƒè¼•é¬†å¯¦ç¾simple JIT çš„åŠŸèƒ½ï¼Œ"),t("strong",[s._v("æš«æ™‚")]),s._v("è·³éçµ„åˆèªè¨€çš„éƒ¨åˆ†ã€‚(ä½†ä»¥å¾Œé‚„æ˜¯è¦é‚„å‚µè¾£ï¼ŒGodï¼Œäººç”Ÿå¥½é›£ = =)")]),s._v(" "),t("p",[s._v("é‚£å°±æ˜¯ä½¿ç”¨ "),t("code",[s._v("objdump")]),s._v("é€™å€‹åçµ„è­¯å·¥å…·ã€‚å¯ä»¥å…ˆå°‡ä½ çš„å‡½å¼ç·¨è­¯æˆä¸€å€‹"),t("code",[s._v(".o")]),s._v("æª”æ¡ˆã€‚ä¹‹å¾Œå†åˆ©ç”¨ objdump é€™å€‹å·¥å…·å¹«ä½ åçµ„è­¯å¾—åˆ°çµ„åˆèªè¨€è·Ÿæ©Ÿå™¨ç¢¼çš„å°ç…§ï¼Œæ¥ä¸‹ä¾†å°±ä¾†ç¤ºç¯„ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨ã€‚")]),s._v(" "),t("p",[s._v("é¦–å…ˆï¼Œå…ˆå»ºç«‹ä¸€å€‹"),t("code",[s._v("mul.c")]),s._v("æª”æ¡ˆ")]),s._v(" "),t("div",{staticClass:"language-C line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mul")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" a"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" b"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" a "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" b"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("ä¹‹å¾Œç·¨è­¯æˆ"),t("code",[s._v(".o")]),s._v("æª”ï¼Œå†åˆ©ç”¨"),t("code",[s._v("objdump")]),s._v("é€™å€‹å·¥å…·åçµ„è­¯")]),s._v(" "),t("p",[s._v("æ¥ä¸‹ä¾†ï¼Œè¼¸å…¥æŒ‡ä»¤")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("objdump -j .text -d mul.o -M intel\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("code",[s._v("-j")]),s._v(" : åªé¡¯ç¤ºæŒ‡å®š section çš„å€åŸŸ(section çš„æ¦‚å¿µè·Ÿ ELF æª”æ¡ˆæ ¼å¼æœ‰é—œï¼Œä»¥å¾Œæœƒè«‡åˆ°)\n"),t("img",{attrs:{src:"https://i.imgur.com/g3D5aIM.png",alt:""}})]),s._v(" "),t("p",[t("code",[s._v("-d")]),s._v(" : ä½ è¦åçµ„è­¯å“ªå€‹äºŒé€²åˆ¶æª”æ¡ˆ(*.o, åŸ·è¡Œæª”ç­‰)")]),s._v(" "),t("p",[t("code",[s._v("-M")]),s._v(" : é¸æ“‡ä½ è¦åçµ„è­¯çš„æŒ‡ä»¤é›†æ¶æ§‹çµ„åˆèªè¨€")]),s._v(" "),t("p",[s._v("å…¶ä»–é¸é …ä¸è´…è«‡ï¼Œå¯ä»¥è¼¸å…¥ "),t("code",[s._v("objdump -H")]),s._v(" çœ‹çœ‹")]),s._v(" "),t("p",[s._v("ä¹‹å¾Œå¾—åˆ°è¨Šæ¯")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("mul.o:     file format elf64-x86-64\n\nDisassembly of section .text:\n\n0000000000000000 <mul>:\n   0:   55                      push   rbp\n   1:   48 89 e5                mov    rbp,rsp\n   4:   89 7d fc                mov    DWORD PTR [rbp-0x4],edi\n   7:   89 75 f8                mov    DWORD PTR [rbp-0x8],esi\n   a:   8b 75 fc                mov    esi,DWORD PTR [rbp-0x4]\n   d:   0f af 75 f8             imul   esi,DWORD PTR [rbp-0x8]\n  11:   89 f0                   mov    eax,esi\n  13:   5d                      pop    rbp\n  14:   c3                      ret\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[s._v("ç•¶ç„¶ï¼Œåœ¨é€™è£¡ä½ ä¹Ÿå¯ä»¥ä¸ç”¨æŒ‡å®š intel æ¶æ§‹")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("objdump -j .text -d mul.o\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("å¾—åˆ°")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("mul.o:     file format elf64-x86-64\n\n\nDisassembly of section .text:\n\n0000000000000000 <mul>:\n   0:   55                      push   %rbp\n   1:   48 89 e5                mov    %rsp,%rbp\n   4:   89 7d fc                mov    %edi,-0x4(%rbp)\n   7:   89 75 f8                mov    %esi,-0x8(%rbp)\n   a:   8b 75 fc                mov    -0x4(%rbp),%esi\n   d:   0f af 75 f8             imul   -0x8(%rbp),%esi\n  11:   89 f0                   mov    %esi,%eax\n  13:   5d                      pop    %rbp\n  14:   c3                      retq\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("p",[s._v("é€™å€‹å°æˆ‘å€‘å¾ˆæœ‰å¹«åŠ©ï¼Œæˆ‘å€‘å¾—åˆ°æ©Ÿå™¨ç¢¼è·Ÿå®ƒå°æ‡‰çš„çµ„åˆèªè¨€ï¼Œä¹Ÿå°±æ˜¯èªª")]),s._v(" "),t("ol",[t("li",[s._v("æˆ‘å€‘å¯ä»¥åˆ©ç”¨æ©Ÿå™¨ç¢¼å®Œæˆç¬¬ä¸€éƒ¨ä»½çš„simple JIT")]),s._v(" "),t("li",[s._v("æˆ‘å€‘ä¹Ÿå¯ä»¥æŒ‡å®šæŒ‡ä»¤é›†æ¶æ§‹å¾Œçµåˆå°æ‡‰çš„çµ„åˆèªè¨€è·ŸCç¨‹å¼ï¼Œåˆ©ç”¨æ–¹æ‰çš„"),t("code",[s._v("dynasm")]),s._v(" å·¥å…·å¹«æˆ‘å€‘é€²è¡Œè™•ç†")])]),s._v(" "),t("p",[s._v("ä¸€é­šå…©åƒ ? ä¸å¥½å— ğŸ˜…ï¼Œä¸éé‚„æ˜¯éœ€è¦ç†è§£çµ„åˆèªè¨€è·ŸæŒ‡ä»¤é›†æ¶æ§‹çš„ç›¸é—œçŸ¥è­˜ï¼Œä½†é€™å€‹å·¥å…·è‘—å¯¦å¯ä»¥è¼”åŠ©æˆ‘å€‘æ›´å¿«é”æˆç›®æ¨™ã€‚")]),s._v(" "),t("p",[s._v("æ¥ä¸‹ä¾†å°±æŠŠé€™æ®µ code æ‹¿å»ç”¨åœ¨ç¬¬ä¸€éƒ¨åˆ†è·Ÿç¬¬äºŒéƒ¨åˆ†å§~~")]),s._v(" "),t("p",[s._v("é¦–å…ˆç¬¬ä¸€éƒ¨åˆ†ï¼Œå°±æ˜¯æ¯”è¼ƒäººå·¥ä¸€é»ï¼ŒæŠŠæ©Ÿå™¨ç¢¼å…¨éƒ¨éƒ½è¼¸å…¥å­—å…ƒé™£åˆ—å…§ï¼Œå†æŒ‡å®šåˆ°mmap åˆ†é…çš„å¯åŸ·è¡Œè¨˜æ†¶é«”å€æ®µã€‚")]),s._v(" "),t("p",[t("code",[s._v("obj_jit_boy.c")])]),s._v(" "),t("div",{staticClass:"language-C line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<stdio.h>")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// printf")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<string.h>")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// memcpy")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<sys/mman.h>")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// mmap, munmap")])]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Hexadecimal x86_64 machine code for: int mul (int a, int b) { return a * b; }")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("unsigned")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),s._v(" code "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x55")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// push rbp")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x48")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x89")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0xe5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// mov rbp, rsp")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x89")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x7d")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0xfc")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// mov DWORD PTR [rbp-0x4],edi")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x89")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x75")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0xf8")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// mov DWORD PTR [rbp-0x8],esi")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x8b")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x75")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0xfc")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// mov esi,DWORD PTR [rbp-04x]")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x0f")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0xaf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x75")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0xf8")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// imul esi,DWORD PTR [rbp-0x8]")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x89")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0xf0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// mov eax,esi")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x5d")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// pop rbp")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0xc3")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ret")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// allocate executable memory via sys call")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" mem "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mmap")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NULL")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("sizeof")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("code"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" PROT_WRITE "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" PROT_EXEC"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                        MAP_ANON "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" MAP_PRIVATE"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// copy runtime code into allocated memory")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("memcpy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("mem"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" code"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("sizeof")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("code"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// typecast allocated memory to a function pointer")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("func"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" mem"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// call function pointer")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%d * %d = %d\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("func")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Free up allocated memory")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("munmap")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("mem"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("sizeof")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("code"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br")])]),t("p",[s._v("å†ä¾†ç¬¬äºŒéƒ¨åˆ†ï¼Œçµåˆçµ„åˆèªè¨€åˆ° dynasm çš„æ–¹æ³•ï¼Œé€™é‚Šè¦æ³¨æ„å¹¾é»")]),s._v(" "),t("ul",[t("li",[s._v("æ³¨æ„æŒ‡ä»¤åŠæ¶æ§‹")]),s._v(" "),t("li",[s._v("ä¸èƒ½æŠŠå‰›å‰›objdumpçš„çµ„èªç›´æ¥è¤‡è£½è²¼ä¸Š")])]),s._v(" "),t("blockquote",[t("p",[s._v("é—œæ–¼ç¬¬äºŒé»æˆ‘è©¦éï¼ŒåŸ·è¡Œæ™‚å †ç–Šçš„ push è·Ÿ pop å¯èƒ½dynasm å¹«ä½ åšäº†ï¼Œdynasm å¯èƒ½è¦è®“ä½ çš„çµ„èªå°ˆæ³¨åœ¨å‡½å¼åŠŸèƒ½æœ¬èº« ? (é€™é»å¾…ç¢ºèª)")])]),s._v(" "),t("p",[s._v("åŸæœ¬")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("|  push   rbp\n|  mov    rbp, rsp\n|  mov    dword [rbp-0x4], edi\n|  mov    dword [rbp-0x8], esi \n|  mov    esi, dword [rbp-0x4] \n|  imul   esi, dword [rbp-0x8]  \n|  mov    eax,esi\n|  pop    rbp\n|  ret\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("ç¨å¾®ä¿®æ”¹")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("//|  push   rbp\n//|  mov    rsp, rbp\n|  mov    dword [rsp-0x4], edi\n|  mov    dword [rsp-0x8], esi \n|  mov    esi, dword [rsp-0x4] \n|  imul   esi, dword [rsp-0x8]  \n|  mov    eax,esi\n|  ret\n//|  pop    rbp\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("div",{staticClass:"language-C line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// DynASM directives.")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("arch x64\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("actionlist actions\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// This define affects "|" DynASM lines.  "Dst" must')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// resolve to a dasm_State** that points to a dasm_State*.")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("Dst")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("state")])]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<stdio.h>")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" argc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("argv"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        \n        dasm_State "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("state"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("initjit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("state"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" actions"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        \n        "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("  mov    dword "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("rsp"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" edi\n        "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("  mov    dword "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("rsp"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x8")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" esi \n        "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("  mov    esi"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" dword "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("rsp"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" \n        "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("  imul   esi"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" dword "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("rsp"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x8")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("  \n        "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("  mov    eax"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("esi\n        "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("  ret\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Link the code and write it to executable memory.")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("fptr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("jitcode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("state"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        \n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Call the JIT-ted function.")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" ret "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("fptr")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%d * %d = %d\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ret"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Free the machine code.")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("free_jitcode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("fptr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" ret"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br")])]),t("hr"),s._v(" "),t("h2",{attrs:{id:"å››ã€part-1-ç¸½çµ"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#å››ã€part-1-ç¸½çµ"}},[s._v("#")]),s._v(" å››ã€Part 1 ç¸½çµ")]),s._v(" "),t("p",[s._v("åœ¨ Part 1ï¼Œæˆ‘å€‘å¯¦åšäº†ä¸‹åˆ—å¹¾ç¨®æ–¹æ³•")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("ç¬¬ä¸€éƒ¨åˆ†: ç›´æ¥æŠŠæ©Ÿå™¨ç¢¼æ”¾é€² mmap å¯åŸ·è¡Œè¨˜æ†¶é«”å€æ®µåŸ·è¡Œï¼Œå›°é›£çš„é»æ˜¯è¦å…ˆçŸ¥é“åŠŸèƒ½å°æ‡‰çš„æ©Ÿå™¨ç¢¼")])]),s._v(" "),t("li",[t("p",[s._v("ç¬¬äºŒéƒ¨åˆ†: åˆ©ç”¨ dynasm code generator å¹«åŠ©æˆ‘å€‘ç”Ÿæˆæ©Ÿå™¨ç¢¼ï¼Œå›°é›£çš„é»æ˜¯è¦ç†Ÿæ‚‰ dynasm æ€éº¼ç”¨ï¼Œä»¥åŠéœ€è¦å…ˆå…·å‚™ä¸€äº›çµ„èªçš„çŸ¥è­˜")])]),s._v(" "),t("li",[t("p",[s._v("ç¬¬ä¸‰éƒ¨åˆ†: æˆ‘å€‘åˆ©ç”¨ç¨å¾®ç¹é è·¯çš„æ–¹å¼ï¼Œå…ˆç·¨è­¯å‡½æ•¸ï¼Œå†ç”¨ objdump åçµ„è­¯å¾—åˆ°æ©Ÿå™¨ç¢¼è·Ÿçµ„åˆèªè¨€ï¼Œå¯ä»¥ç¨å¾®æ”¹å–„å‰é¢å…©éƒ¨åˆ†çš„å›°é›£çš„é»")])])]),s._v(" "),t("p",[s._v("ä½†æ˜¯è¦å­¸ç·¨è­¯å™¨è·Ÿ JITï¼Œçµ„åˆèªè¨€çš„çŸ¥è­˜é²æ—©éƒ½å¾—è£œå®ŒğŸ¤£")]),s._v(" "),t("hr"),s._v(" "),t("h2",{attrs:{id:"äº”ã€å°ˆæ¡ˆåŸ·è¡Œæ–¹å¼"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#äº”ã€å°ˆæ¡ˆåŸ·è¡Œæ–¹å¼"}},[s._v("#")]),s._v(" äº”ã€å°ˆæ¡ˆåŸ·è¡Œæ–¹å¼")]),s._v(" "),t("ol",[t("li",[s._v("åŸ·è¡Œç¬¬ä¸€éƒ¨ä»½çš„ Simple JIT")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" jit_toy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" ./jittoy "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$?")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("è¨˜å¾—æ¸¬è©¦æ•´æ•¸ "),t("strong",[s._v("<=255")]),s._v("ï¼Œå› ç‚ºç¨‹å¼å›å‚³ç‹€æ…‹åªæœ‰ 8 bitsï¼Œå°å¿ƒæº¢ä½æœƒå‡ºç¾ mod 256 çš„çµæœ")]),s._v(" "),t("ol",{attrs:{start:"2"}},[t("li",[s._v("åŸ·è¡Œç¬¬äºŒéƒ¨ä»½çš„ dynasm JIT")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" jit_dynasm"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" ./jit_dynasm "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$?")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ol",{attrs:{start:"3"}},[t("li",[s._v("åŸ·è¡Œç¬¬ä¸‰éƒ¨ä»½çš„ objdump + simple JIT")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" clean"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" obj_jit_toy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" ./obj_jit_toy\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ol",{attrs:{start:"4"}},[t("li",[s._v("åŸ·è¡Œç¬¬ä¸‰éƒ¨ä»½çš„ objdump + obj_jit_dynasm")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" clean"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" obj_jit_dynasm"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" ./obj_jit_dynasm\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("hr"),s._v(" "),t("h1",{attrs:{id:"åƒè€ƒç¶²ç«™"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#åƒè€ƒç¶²ç«™"}},[s._v("#")]),s._v(" åƒè€ƒç¶²ç«™")]),s._v(" "),t("ol",[t("li",[t("p",[t("a",{attrs:{href:"https://blog.reverberate.org/2012/12/hello-jit-world-joy-of-simple-jits.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Hello, JIT World: The Joy of Simple JITs"),t("OutboundLink")],1)])]),s._v(" "),t("li",[t("p",[t("a",{attrs:{href:"https://github.com/jserv/jit-construct",target:"_blank",rel:"noopener noreferrer"}},[s._v("å¿…è®€ : interpreter-compiler-jit"),t("OutboundLink")],1)])]),s._v(" "),t("li",[t("p",[t("a",{attrs:{href:"https://www.zhihu.com/question/54748092/answer/141903877",target:"_blank",rel:"noopener noreferrer"}},[s._v("æœ‰å“ªäº›å¸¸ç”¨ JIT ç®—æ³•ï¼Ÿ"),t("OutboundLink")],1)])]),s._v(" "),t("li",[t("p",[t("a",{attrs:{href:"http://accu.cc/content/jit_tour/brainfuck_interpreter/",target:"_blank",rel:"noopener noreferrer"}},[s._v("JIT ç·¨è­¯å™¨"),t("OutboundLink")],1)])]),s._v(" "),t("li",[t("p",[t("a",{attrs:{href:"https://github.com/haberman/jitdemo",target:"_blank",rel:"noopener noreferrer"}},[s._v("jitdemo çš„ github "),t("OutboundLink")],1)])]),s._v(" "),t("li",[t("p",[t("a",{attrs:{href:"https://nickdesaulniers.github.io/blog/2013/04/03/basic-jit/",target:"_blank",rel:"noopener noreferrer"}},[s._v("basic-jit"),t("OutboundLink")],1)])])]),s._v(" "),t("h1",{attrs:{id:"å»¶ä¼¸é–±è®€"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#å»¶ä¼¸é–±è®€"}},[s._v("#")]),s._v(" å»¶ä¼¸é–±è®€")]),s._v(" "),t("ol",[t("li",[t("p",[t("a",{attrs:{href:"https://www.youtube.com/watch?v=2BB39q6cqPQ&t=905s",target:"_blank",rel:"noopener noreferrer"}},[s._v("Matthew Page - How to JIT: Writing a Python JIT from scratch in pure Python - PyCon 2019"),t("OutboundLink")],1)]),s._v(" "),t("ul",[t("li",[s._v("python åœ¨å¯«è¼ƒåº•å±¤(mmap, memmove, peachpy)ç­‰ï¼Œä¸­é–“çš„å‘ä¸å°‘ã€‚ä½¿ç”¨é€™äº›å¥—ä»¶æœƒç‰½æ¶‰åˆ° windows å’Œ unix-like ç³»çµ±çš„å› ç´ è€Œæœ‰æ‰€ä¸åŒï¼Œæ‰€ä»¥æƒ³è¦æ”¹æˆä½¿ç”¨ C èªè¨€")])])]),s._v(" "),t("li",[t("p",[t("a",{attrs:{href:"https://github.com/Maratyszcza/PeachPy",target:"_blank",rel:"noopener noreferrer"}},[s._v("PeachPy-é¡ä¼¼ dynasm ä¸€æ¨£çš„å¥—ä»¶"),t("OutboundLink")],1)])]),s._v(" "),t("li",[t("p",[t("a",{attrs:{href:"https://github.com/dolphindb/Tutorials_CN/blob/master/jit.md",target:"_blank",rel:"noopener noreferrer"}},[s._v("DolphinDB JITæ•™ç¨‹"),t("OutboundLink")],1)])])])])}),[],!1,null,null,null);a.default=e.exports}}]);